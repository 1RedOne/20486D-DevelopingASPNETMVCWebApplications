# Module 3: Configuring Middleware and Services in ASP.NET Core

# Lab: Configuring Middleware and Services in ASP.NET Core 

### Lab Setup

### Preparation Steps

1.	Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.

###	Exercise 1: Working with Static Files

#### Task 1: Create a new project using the ASP.NET Core Empty project template.

1.	Start **Visual Studio 2017**.

2.	On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3.	In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4.	In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5.	In the **Name** box, type **PollBall**, and then click **OK**.

6.	In the **Location** box, replace its content with **Allfiles\Mod03\Labfiles\01_PollBall_begin**, and then click **OK**.

7.	In the result pane of the **New ASP.NET Core Web Application** dialog box, click **Empty**, and then click **OK**.

8. In the **PollBall - Microsoft Visual Studio** window, verify that the **Solution Explorer** pane is opened. If not, go to **View**, and then click **Solution Explorer**.

9. In the **Solution Explorer** pane, of the **ConfigureServiceExample - Microsoft Visual Studio** window, click **Startup.cs**.

10. In the **Startup.cs** code window, delete the **Configure** method with its content.

11. In the **Startup.cs** code window, place the cursor within the **Startup** class code block,  bellow the **ConfigureServices** method, and then type the following code. 
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("Hello World!");
        });
    }
```

#### Task 2: Run the application.

1. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.
> **Note**: The **app.Run** generates the **Hello World !** text that is displayed in the browser.

5. In the **Microsoft Edge** window, click **Close**.

6. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

#### Task 3: Add an HTML file to the wwwroot folder.

1.	In the Solution Explorer pane of the **PollBall - Microsoft Visual Studio** window, right-click **wwwroot**, point to **Add**, and then click **New Folder**.

2.	In the Solution Explorer pane, name the newly created folder as **css**, and then press Enter.

3.	In the **File Explorer** window, go to **Allfiles\Mod03\Labfiles\01_PollBall_begin**.

4.	In the **01_PollBall_begin** window, right-click **images** folder, and then click **Copy**.

5.	In the **File Explorer** window, go to **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot**.

6.	In the **wwwroot** window, right-click an empty space, and then click **Paste**.
     > **Note**: Verify that in the Solution Explorer pane, under **wwwroot**,  the images folder is displayed.

7.	In the **File Explorer** window, go to **Allfiles\Mod03\Labfiles\01_PollBall_begin**.

8.	In the **01_PollBall_begin** window, right-click **style.css** file, and then click **Copy**.

9.	In the **File Explorer** window, go to **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot\css**.

10. In the **Style** window, right-click an empty space, and then click **Paste**.

11.	In the Solution Explorer pane of the **PollBall - Microsoft Visual Studio** window, right-click on the **wwwroot** folder, point to **Add**, and then click **New Item**.

12.	In the **Add New Item – PollBall** dialog box, click **HTML Page**.

13. In the **Name** box of the **Add New Item – PollBall** dialog box, type **poll_questions.html**, and then click **Add**.

14. In the **poll_questions.html** code window, in the **BODY** element,  type the following code, and then press Enter.
```cs
    <p class="head">
        <h1>Favorite ball game poll</h1>
        Please select your favorite ball game and then press submit.
        The poll is anonymouse and does not contain names.
    </p>
```

15. In the **BODY** element, below the **P** element, type the following code.
```cs
    <form class="submit-form">
        <div class="main-div">

        </div>
        <div class="submit-batch">
            <input type="submit" value="Submit Query" />
        </div>
    </form>
```

16. In the **DIV** element  with the **main-div** class attribute, type the following code, and then press Enter.
```cs
    <div class="main-batch1">
        <div class="item">
            <div class="img-item"><img src="images\basketball.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Basketball"> Basketball</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\football.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Football"> Football</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\soccer.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Soccer"> Soccer</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\vollyball.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Vollyball"> Vollyball</div>
        </div>
    </div>
```

17. In the **DIV** element with the **main-div** class attribute, **below** the code you just added, type the following code.
```cs
    <div class="main-batch2">
        <div class="item">
            <div class="img-item"><img src="images\billiard.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Billiard"> Billiard</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\Golf.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Golf"> Golf</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\Air Hockey.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="AirHockey"> Air Hockey</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\tennis.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Tennis"> Tennis</div>
        </div>
    </div>
```

#### Task 4: Run the application – content of HTML not displayed.

1. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.

2. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/poll_questions.html and then press Enter. 
     > **Note**: The **app.Run** generates the **Hello World !** text that is displayed in the browser, and the **poll_questions.html** file is not displayed.

3. In the **Microsoft Edge** window, click **Close**.

4. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.
 
#### Task 5: Enable working with static files.

1. In the **Solution Explorer** pane,  click **Startup.cs**.

2. Locate the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
```

3. Place the mouse cursor at the end of the code, press Enter twice, and then type the following code.
```cs
    app.UseStaticFiles();
```

#### Task 6: Run the application – content of HTML is displayed.

1. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.

2. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/poll_questions.html, and then press Enter. 
     > **Note**: The **poll_questions.html** content is displayed in the browser, but the HTML content is poorly designed.

3. In the **Microsoft Edge** window, click **Close**.

4. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

5. On the **Solution Explorer** pane, click **poll_questions.html**.

6. In the **poll_questions.html** code window, locate the following code, and then press Enter.
```cs
    <title></title>
```

7. In the **poll_questions.html** code window, in the **HEAD** element, below the **TITLE** element,  type the following code.
```cs
    <link rel="stylesheet" href="css\style.css"/>
```

8. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.

9. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/poll_questions.html and then press Enter. 
     > **Note**: The **poll_questions.html** content is displayed in the browser with a design from the **style.css** file.

10. In the **Microsoft Edge** window, click **Close**.

11. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.


#### Task 7: Add an HTML file outside of the wwwroot folder.

1. In the **File Explorer** window, Go to **Allfiles\Mod03\Labfiles\01_PollBall_begin**, right-click the **test.html** file, and then click **Copy**. 

2. In the **File Explorer** window, go to **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall**, right-click an empty space, and then click **Paste**.

#### Task 8: Run the application – content of HTML outside wwwroot folder not displayed.

1. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.

2. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/test.html, and then press Enter. 
     > **Note**: The **app.Run** generates the **Hello World !** text that is displayed in the browser.  By default, content from files outside the wwwroot directory are not visible in the browser.

3. In the **Microsoft Edge** window, click **Close**.

4. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

>**Result**: At the end of this exercise, you will be able to add and work with static files inside an **ASP.NET Core** project.

###	Exercise 2: Creating Custom Middleware

#### Task 1: Create a middleware.

1. In the Solution Explorer pane of the  **PollBall – Microsoft Visual Studio**  window, click  **Startup.cs**.

2. In the **Startup.cs** code window, locate the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
```

3. Place the mouse cursor at the end of the code, press Enter twice, and then type the following code.
```cs
    app.Use(async (context, next) =>
    {
    
    });
```

4. Place the mouse cursor within the custom middleware code block you just created, and then type the following code.
```cs
    if (context.Request.Query.ContainsKey("favorite"))
    {
    
    }
    else await next.Invoke();
``` 

5. In the **if** statement code block, type the following code, and then press Enter twice.
```cs
    string selectedValue = context.Request.Query["favorite"];
```

6. In the **if** statement code block,  below the last statement you typed, write the following code.
```cs
    await context.Response.WriteAsync("Selected Value is = " + selectedValue);
```

#### Task 2: Run the application.

1. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.

2. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/poll_questions.html, and then press Enter. 

3. In the **Microsoft Edge**, click the **Basketball** radio button, and then click the **Submit Query** button.
     > **Note**: The **app.Use** middleware generates the following text that is displayed in the browser: Selected Value is = Basketball.

4. In the **Microsoft Edge** window, click **Close**.

5. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.
 
#### Task 3: Change the order of middleware.

1. In the Solution Explorer of the **PollBall –  Microsoft Visual Studio** window, click **Startup.cs**.

2. In the **Startup.cs** code window, select the following code. 
```cs
    app.UseStaticFiles();
```

3. Right-click the selected code, and then click **Cut**.

4. In the **Startup.cs** code window, locate the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
```

5. Place the mouse cursor at the end of the located code, press Enter, right-click at the cursor location, and then click **Paste**.

6. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.

7. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/poll_questions.html and then press Enter. 

8. In the **Microsoft Edge**, click the **Basketball** radio button, and then click the **Submit Query** button.
     > **Note**: The **poll_questions.html** file content is displayed in the browser.

9. In the **Microsoft Edge** window, click **Close**.

10. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

11. In the **Startup.cs** code window, select the following code.
```cs
    app.UseStaticFiles();
```

12. Right-click the selected code, and then click **Cut**.

13. In the **Startup.cs** code window, locate the following code.
```cs
    app.Use(async (context, next) =>
    {
        if (context.Request.Query.ContainsKey("favorite"))
        {
            string selectedValue = context.Request.Query["favorite"];
            await context.Response.WriteAsync("Selected Value is = " + selectedValue);
        }
        else await next.Invoke();
    });
```

14. Place the mouse cursor at the end of the located code, press Enter twice, right-click at the cursor location, and then click **Paste**. 

15. In the **Startup.cs** code window, select the following code.
```cs
    else await next.Invoke();
```

16. Replace the code you selected with the following code.
```cs
    //else await next.Invoke();
```

17. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.

18. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/poll_questions.html, and then press Enter. 
     > **Note**: An empty page is displayed in the browser (You might need to refresh the page in order to see the results). Causing the next.Invoke method invocation to be commented, prevents the invocation of the UseStaticFiles method. 

19. In the **Microsoft Edge** window, click **Close**.

20. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

21. In the **Startup.cs** code window, select the following code.
```cs
    //else await next.Invoke();
```

22. Replace the code you selected with the following code.
```cs
    else await next.Invoke();
```
 
>**Result**: At the end of this exercise, you will be able to create a custom middleware and receive HTML form calls to it.

###	Exercise 3: Using Dependency Injection

#### Task 1: Define an interface for a service.

1. In the Solution Explorer pane of the **PollBall - Microsoft Visual Studio** window, right-click **PollBall** project file, point to **Add**, and then click **New Folder**.

2.	In the Solution Explorer pane, name the newly created folder as **Services**, and then press Enter.

3.	In the Solution Explorer pane of the **PollBall  - Microsoft Visual Studio** window, right-click the **Services** folder, point to **Add**, and then click **Class**.

4.	In the **Add New Item - PollBall** dialog box, in the **Name** text box, type **SelectedGame**, and then click **Add**.

5.	In the **SelectedGame.cs** code window, select the following code.
```cs
    public class SelectedGame
```

6. Replace the code you selected with the following code.
```cs
    public enum SelectedGame
```

7. Place the mouse cursor within the **SelectedGame** enum block you just created, press Enter, and then type the following code.
```cs
    Basketball,
    Football,
    Soccer,
    Vollyball,
    Billiard,
    AirHockey,
    Golf,
    Tennis
```

8.	In the Solution Explorer pane of the **PollBall - Microsoft Visual Studio** window, right-click on the **Services** folder, point to **Add**, and then click **New Item**.

9.	In the **Add New Item – PollBall** dialog box, click **Interface**.

10. In the **Name** box of the **Add New Item – PollBall** dialog box, type **IPollResultsService**, and then click **Add**.

11. Place the mouse cursor within the **IPollResultsService** Interface block you just created, press Enter, and then type the following code. 
```cs
    void AddVote(SelectedGame game);
    SortedDictionary<SelectedGame, int> GetVoteResult();
``` 

12. In the **IPollResultsService.cs** code window, select the following code.
```cs
    interface IPollResultsService
```

13. Replace the code you selected with the following code.
```cs
    public interface IPollResultsService
```

#### Task 2: Define an implementation for the service.

1.	In the Solution Explorer pane of the **PollBall - Microsoft Visual Studio** window, right-click the **Services** folder, point to **Add**, and then click **Class**.

2.	In the **Add New Item - PollBall** dialog box, in the **Name** text box, type **PollResultsService**, and then click **Add**.

3. In the **PollResultsService.cs** code window, locate the following code.
```cs
    public class PollResultsService
```

4. Append the following code to the existing line of code. 
```cs
     : IPollResultsService
```

5.	Place the mouse cursor within the **PollResultsService** class code block you just created, press Enter, and then type the following code.
```cs
    private Dictionary<SelectedGame, int> SelectionVotes { get; set; }
```

6. Place the mouse cursor at the end of the **SelectionVotes** property code, press Enter twice, and then type the following code.
```cs
    public PollResultsService()
    {
        SelectionVotes = new Dictionary<SelectedGame, int>();
    }
```

7. Place the mouse cursor at the end of the **PollResultsService** constructor, press Enter twice, and then type the following code.
```cs
    public void AddVote(SelectedGame game)
    {
    
    }
```

8. Place the mouse cursor within the **AddVote** method block you just created, and then type the following code.
```cs
    if (SelectionVotes.ContainsKey(game))
        SelectionVotes[game]++;
    else
        SelectionVotes.Add(game, 1);
``` 

9. Place the mouse cursor at the end of the **AddVote** method, press Enter twice, and then type the following code.
```cs
    public SortedDictionary<SelectedGame, int> GetVoteResult()
    {
    
    }
```

10. Place the mouse cursor within the **GetVoteResult** method block you just created, and then type the following code. 
```cs
    SortedDictionary<SelectedGame, int> sortedSelectionVotes = new SortedDictionary<SelectedGame, int>();
    foreach (KeyValuePair<SelectedGame, int> item in SelectionVotes)
    {
        sortedSelectionVotes.Add(item.Key, item.Value);
    }
    return sortedSelectionVotes;
```

#### Task 3: Use dependency injection.

1. In the **Solution Explorer** click **Startup.cs**.

2. In the **Startup.cs** code window, locate the following code.
```cs
    using Microsoft.Extensions.DependencyInjection;
```

3. Place the mouse cursor at the end of the code, press Enter, and then type the following code.
```cs
    using PollBall.Services;
```

4. In the **Startup.cs** code window, select the following code.
```cs
    await context.Response.WriteAsync("Hello World!");
```

5. Replace the code you selected with the following code.
```cs
    await context.Response.WriteAsync("This text was generated by the app.run middleware. wwwroot folder path: " + env.WebRootPath);
```

6. In the **Startup.cs** code window, select the following code.
```cs
    public void Configure(IApplicationBuilder app)
```

7. Replace the code you selected with the following code.
```cs
    public void Configure(IApplicationBuilder app, IPollResultsService pollResults)
```

8. In the **Startup.cs** code window, locate the following code.
```cs
    string selectedValue = context.Request.Query["favorite"];
```

9. Place the mouse cursor at the end of the code, press Enter, and then type the following code.
```cs
    SelectedGame selectedGame = (SelectedGame)Enum.Parse(typeof(SelectedGame), selectedValue);
    pollResults.AddVote(selectedGame);
```

10.	In the **Startup.cs** code window, select the following code.
```cs
    await context.Response.WriteAsync("Selected Value is = " + selectedValue);
```

11. Replace the code you selected with the following code.
```cs
    SortedDictionary<SelectedGame, int> gameVotes = pollResults.GetVoteResult();

    foreach (KeyValuePair<SelectedGame,int> currentVote in gameVotes)
    {
        await context.Response.WriteAsync($"<p> Game name: {currentVote.Key}, Votes: {currentVote.Value} </p>");
    }
```

12. In the **Startup.cs** code window, locate the following code.
```cs
    public void ConfigureServices(IServiceCollection services)
```

13. Place the mouse cursor within the **ConfigureServices** method block, press Enter, and then type the following code.
```cs
    services.AddSingleton<IPollResultsService, PollResultsService>();
```

#### Task 4: Run the application.

1. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.
     > **Note**: The **app.Run** middleware generates the following text that is displayed in the browser: **This text was generated by the app.run middleware. wwwroot folder path:** [local path to your wwwroot folder].

2. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/poll_questions.html, and then press Enter. 

3. In the **Microsoft Edge**, click the **Basketball** radio button, and then click the **Submit Query** button.
     > **Note**: The **app.Use** middleware generates the following text that is displayed in the browser: Basketball, Votes: 1

4. Start another **Microsoft Edge** window, Change the URL path to http://localhost:[port]/poll_questions.html and then press Enter.
     > **Note**: Verify that the port number in the URL of the new **Microsoft Edge** window, is identical to the port number in the URL of the window that is created in step 2.

5. In the **Microsoft Edge**, click the **Football** radio button, and then click the **Submit Query** button.
     > **Note**: The **app.Use** middleware generates the following text that is displayed in the browser: <br>
     >                  Game name: Basketball, Votes: 1<br>
     >                  Game name: Football, Votes: 1

6. Start another **Microsoft Edge** window, Change the URL path to http://localhost:[port]/poll_questions.html and then press Enter.
     > **Note**: Verify that the port number in the URL of the new **Microsoft Edge** window, is identical to the port number in the URL of the window that is created in step 2.

7. In the **Microsoft Edge**, click the **Basketball** radio button, and then click the **Submit Query** button.
     > **Note**: The **app.Use** middleware generates the following text that is displayed in the browser: <br>
     >                  Game name: Basketball, Votes: 2<br>
     >                  Game name: Football, Votes: 1

8. In the **Microsoft Edge** window, click **Close**.

9. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

>**Result**: At the end of this exercise, you will be able to create and use a service with **Dependency Injection**.


###	Exercise 4: Injecting a Service to a Controller

#### Task 1: Enable working with MVC.

1. In the **Startup.cs** code window, Locate the following code.
```cs
    app.UseStaticFiles();
```

2. Place the mouse cursor at the end of the code, press Enter twice, and then type the following code.
```cs
    app.UseMvcWithDefaultRoute();
```

3. In the **Startup.cs** code window, locate the following code.
```cs
    services.AddSingleton<IPollResultsService, PollResultsService>();
```

4. Place the mouse cursor at the end of the code, press Enter, and then type the following code.
```cs
    services.AddMvc();
```

#### Task 2: Add a controller.

1. In the **Solution Explorer** pane of the **PollBall - Microsoft Visual Studio** window, right-click the **PollBall** project file, point to **Add**, and then click **New Folder**.

2.	In the Solution Explorer pane, name the newly created folder as **Controllers**, and then press Enter.

3. In the Solution Explorer pane of the **PollBall - Microsoft Visual Studio** window, right-click the **Controllers** folder, point to **Add**, and then click **Controller**.

4.	In the **Add Scaffold - PollBall** dialog box, select the **MVC Controller- Empty** option, and then click **Add**.

5.	 in the **Controller name** box, type **HomeController**, and then click **Add**.

6.	In the **HomeController.cs** code window, select the following code.
```cs
    return View();
```

7.	Replace the code you selected with the following code.
```cs
    return Content("Hello from controller");
```

#### Task 3: Run the application.

1. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.
     > **Note**: The **controller** generates the **Hello from controller** text that is displayed in the browser.

2. In the **Microsoft Edge** window, click **Close**.

3. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

4. In the **Solution Explorer** click **Startup.cs**. 

5. In the **Startup.cs** code window, select the following code. 
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.run middleware. wwwroot folder path: " + env.WebRootPath);
    });
```

6. Right-click the selected code, and then click **Cut**.

7. In the **Startup.cs** code window, locate the following code.
```cs
    public void Configure(IApplicationBuilder app, IPollResultsService pollResults)
    {
```

8. Place the mouse cursor at the end of the code, and then press Enter twice. 

9. Right-click on the cursor location, and then click **Paste**.

10. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.
     > **Note**: The **app.Run** middleware generates the following text that is displayed in the browser: **This text was generated by the app.run middleware. wwwroot folder path:** [local path to your wwwroot folder].

11. In the **Microsoft Edge** window, click **Close**.

12. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

13. In the **Startup.cs** code window, select the following code. 
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.run middleware. app.run is executing. wwwroot folder path: " + env.WebRootPath);
    });
```

14. Right-click the selected code, and then click **Cut**.

15. In the **Startup.cs** code window, locate the following code.
```cs
    app.UseMvcWithDefaultRoute();
```

16. Place the mouse cursor at the end of the code, and then press Enter twice.

17. Right-click on the cursor location, and then click **Paste**.

18. Remove any empty spaces that were left below the **app.Run**, and above the app.UseMvcWithDefaultRoute(); code blocks.

 
#### Task 4: Use Dependency Injection in a controller.

1. In the Solution Explorer pane of the **PollBall - Microsoft Visual Studio** window, click **Startup.cs**. 

13. In the **Startup.cs** code window, select the following code. 
```cs
    SortedDictionary<SelectedGame, int> gameVotes = pollResults.GetVoteResult();

    foreach (KeyValuePair<SelectedGame, int> currentVote in gameVotes)
    {
        await context.Response.WriteAsync($"<p> Game name: {currentVote.Key}, Votes: {currentVote.Value} </p>");
    }
```

3. Replace the selected code with the following code.
```cs
    await context.Response.WriteAsync($"Thank you for submitting the poll");
```

1. In the Solution Explorer pane of the **PollBall - Microsoft Visual Studio** window, under **Controllers**, click **HomeController.cs**.

2. In the **HomeController.cs** code window, locate the following code.
```cs
    using Microsoft.AspNetCore.Mvc;
``` 

3. Place the mouse cursor at the end of the code, press Enter, and type the following code.
```cs
    using PollBall.Services;
    using System.Text;
``` 

4. In the **HomeController.cs** code window, locate the following code.
```cs
    public class HomeController : Controller
    {
``` 

5. Place the mouse cursor at the end of the code, press Enter, type the following code.
```cs
    IPollResultsService _pollResults;
```

6. Place the mouse cursor at the end of the **_pollResults** field code, press Enter twice, type the following code, and then press Enter.
```cs
    public HomeController(IPollResultsService pollResults)
    {
        _pollResults = pollResults;
    }
```

7. In the **HomeController.cs** code window, locate the following code.
```cs
    return Content("Hello from controller");
```

8. Replace the selected code with the following code.
```cs
    StringBuilder results = new StringBuilder();
    SortedDictionary<SelectedGame, int> voteList = _pollResults.GetVoteResult();
    
    foreach (var gameVotes in voteList)
    {
        results.Append($"Game name: {gameVotes.Key}, Votes: {gameVotes.Value}{Environment.NewLine}");
    }
    
    return Content(results.ToString());
``` 

#### Task 5: Run the application.

1. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Start Debugging**.

2. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/poll_questions.html, and then press Enter. 

3. In the **Microsoft Edge**, click the **Basketball** radio button, and then click the **Submit Query** button.
     > **Note**: The **Thank you for submitting the poll** text  is displayed in the browser.
 
4. Start another **Microsoft Edge** window, Change the URL path to http://localhost:[port]/poll_questions.html and then press Enter.
     > **Note**: Verify that the port number in the URL of the new **Microsoft Edge** window, is identical to the port number in the URL of the window that is created in step 2.

5. In the **Microsoft Edge**, click the **Football** radio button, and then click the **Submit Query** button.
     > **Note**: The **Thank you for submitting the poll** text  is displayed in the browser.

6. Start another **Microsoft Edge** window, Change the URL path to http://localhost:[port]/poll_questions.html and then press Enter.
     > **Note**: Verify that the port number in the URL of the new **Microsoft Edge** window, is identical to the port number in the URL of the window that is created in step 2.

7. In the **Microsoft Edge**, click the **Basketball** radio button, and then click the **Submit Query** button.
     > **Note**: The **Thank you for submitting the poll** text  is displayed in the browser.

8. In the **Microsoft Edge**, Change the URL path to http://localhost:[port], and then press Enter. 
     > **Note**: The **controller** generates the following text that is displayed in the browser: 
     >                  Game name: Basketball, Votes: 2<br>
     >                  Game name: Football, Votes: 1 

9. In the **Microsoft Edge** window, click **Close**.

10. On the **DEBUG** menu of the **PollBall –  Microsoft Visual Studio** window, click **Stop Debugging**.

11. On the **FILE** menu of the **PollBall - Microsoft Visual Studio** window, click **Exit**.

>**Result**: At the end of this exercise, you will be able to create controller, and inject a service into it with **Dependency Injection**.

