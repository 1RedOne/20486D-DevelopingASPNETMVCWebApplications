# Module 3: Configuring Middleware and Services in ASP.NET Core

# Lesson 1: Configuring Middleware

### Demonstration: How to Create Custom Middleware

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **ConfigureMiddlewareExample**, and then click **OK**.

6. In the result pane of the **New ASP.NET Core Web Application** dialog box, click **Empty**, and then click **OK**.

7. In the **Solution Explorer** pane, of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Startup.cs**.

8. In the **Startup.cs** code window, delete the **Configure** method with its content.

9. In the **Startup.cs** code window, place the cursor within the **Startup** class code block,  bellow the **ConfigureServices** method, and then type the following code.

```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.run middleware.");
        });
    }
```

10. On the **DEBUG** menu of the **Configure Middleware Example –  Microsoft Visual Studio** window, click **Start Debugging**. 

11. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/UrlTest1, and then press Enter.

    >**Note**: The browser displays **This text was generated by the app.run middleware.** that generated by the **app.Run** middleware.

12. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/UrlTest2, and then press Enter. 

    >**Note**: The browser displays **This text was generated by the app.run middleware.** that generated by the **app.Run** middleware.

13. In the **Microsoft Edge** window, click **Close**.

14. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Stop Debugging**.

15. In the **Startup.cs** code window, locate the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
```

16. Place the mouse cursor at the end of the code, press Enter twice, and then type the following code.
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the custom middleware. URL Path = " + context.Request.Path.Value + "<br />");
    });
```
>**Note**: The value of **context.Request.Path.Value** is request path of the page that submitted the request.

17. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.

18. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/UrlTest1, and then press Enter.
     >**Note**: The browser displays **This text was generated by the custom middleware. URL Path = [URL Path]** that generated by the **app.Use** middleware.
19. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/UrlTest2, and then press Enter. 
     >**Note**: The browser displays **This text was generated by the custom middleware. URL Path = [URL Path]** that generated by the **app.Use** middleware.

20. In the **Microsoft Edge** window, click **Close**.

21. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Stop Debugging**.

22. In the **Startup.cs** code window, locate the following code.
```cs
    await context.Response.WriteAsync("This text was generated by the custom middleware. URL Path = " + context.Request.Path.Value + "<br />");
```

23. Place the mouse cursor at the end of the code, press Enter, and then type the following code.
```cs
    await next.Invoke();
```

24. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.
     >**Note**: The browser displays a results that generated by the app.Use and the app.Run togather. 

25. In the **Microsoft Edge** window, click **Close**.

26. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Stop Debugging**.

27. In the **Startup.cs** code window, select the following code.
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the custom middleware. URL Path = " + context.Request.Path.Value + "<br />");
        await next.Invoke();
    });
```

28. Right-click on the selected code, then then click **Cut**.

29. In the **Startup.cs** code window, locate the following code.
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.run middleware.");
    });
```

30. Place the mouse cursor at the end of the code, press Enter, right-click the specified location, and then click **Paste**.
     >**Note**: It is suggested to remove the empty lines that was created during the **Cut** and **Paste** processes.
     
31. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.
     >**Note**: The browser displays **This text was generated by the app.run middleware.** that generated by the **app.Run** middleware.

32. In the **Microsoft Edge** window, click **Close**.

33. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Stop Debugging**.

34. Select the following code.
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.run middleware.");
    });
```

35. Right-click on the selected code, then then click **Cut**.

36. In the **Startup.cs** code window, locate the following code.
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the custom middleware. URL Path = " + context.Request.Path.Value + "<br />");
                await next.Invoke();
    });
```

37. Place the mouse cursor at the end of the code, press Enter, right-click the specified location, and then click **Paste**.
     >**Note**: It is suggested to remove the empty lines that was created during the **Cut** and **Paste** processes.

38. On the toolbar of the  **ConfigureMiddlewareExample - Microsoft Visual Studio**  window, click  **Save Startup.cs(Ctrl+S)**.

39. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Exit**.

# Lesson 1: Configuring Middleware

### Demonstration: How to Work with Static Files

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **StaticFilesExample**, and then click **OK**.

6.  In the **Location** textbox, write **Allfiles\Mod03\Democode\02_StaticFilesExample_begin**, and then click **OK**. 

7. In the result pane of the **New ASP.NET Core Web Application** dialog box, click **Empty**, and then click **OK**.
      >**Note**: In the **Solution Explorer** see that the **wwwroot** folder is empty.

8.  In the **File Explorer** window, go to **Allfiles\Mod03\Democode\02_StaticFilesExample_begin**.
    
9.  In the **02_StaticFilesExample_begin** window, select the **html_file.html** and the **image_file.jpg** files.
 
10. Right-click the selected files, press right-click, and then click **Copy**.
    
11.  In the **File Explorer** window, go to **Allfiles\Mod03\Democode\02_StaticFilesExample_begin\StaticFilesExample\StaticFilesExample\wwwroot**.
    
12.  In the **wwwroot** window, right-click an empty space, and then click **Paste**.
      >**Note**: In the Solution Explorer pane of the **StaticFilesExample - Microsoft Visual Studio** window, see that the **wwwroot** folder contains both of the copied files (You might need to expand the wwwroot directory to see the files).

13. In the **Solution Explorer** pane, of the **StaticFilesExample - Microsoft Visual Studio** window, click **Startup.cs**.

14. In the **Startup.cs** code window, delete the **Configure** method with its content.

15. In the **Startup.cs** code window, place the cursor within the **Startup** class code block,  bellow the **ConfigureServices** method, and then type the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("Hello World!");
        });
    }
```

16. On the **DEBUG** menu of the **StaticFilesExample –  Microsoft Visual Studio** window, click **Start Debugging**.

17. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/html_file.html, and then press Enter.
     >**Note**: The browser displays **Hello World!** that generated by the **app.Run** middleware.

18. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/image_file.jpg, and then press Enter. 
     >**Note**: The browser displays **Hello World!** that generated by the **app.Run** middleware.

19. In the **Microsoft Edge**, Change the URL path to http://localhost:[port]/nonexisting_path.jpg, and then press Enter. 
     >**Note**: The browser displays **Hello World!** that generated by the **app.Run** middleware.

20. In the **Microsoft Edge** window, click **Close**.

21. On the **DEBUG** menu of the **StaticFilesExample –  Microsoft Visual Studio** window, click **Stop Debugging**

22. In the **Solution Explorer** pane, click **Startup.cs**.

23. In the **Startup.cs** code window, locate the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
```

24. Place the mouse cursor at the end of the code, press Enter, and then type the following code.
```cs
    app.UseStaticFiles();
```

25. On the **DEBUG** menu of the **StaticFilesExample –  Microsoft Visual Studio** window, click **Start Debugging**.

26. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/html_file.html, and then press Enter.
     >**Note**: The HTML file is displayed in the browser.

27. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/image_file.jpg, and then press Enter. 
     >**Note**: The image file is displayed in the browser.

28. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/nonexisting_path.jpg, and then press Enter. 
     >**Note**: The UseStaticFiles middleware cannot find a file by the supplied request path, and calls the next middleware in the pipline. The next middleware is app.Run. Therefore **Hello World!** is displayed in the browser.
     

29. In the **Microsoft Edge** window, click **Close**.

30. On the **DEBUG** menu of the **StaticFilesExample –  Microsoft Visual Studio** window, click **Stop Debugging**.

31. On the **FILE** menu of the **StaticFilesExample - Microsoft Visual Studio** window, click **Exit**.

# Lesson 2: Configuring Services

### Demonstration: How to Use Dependency Injection

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **ConfigureServiceExample**, and then click **OK**.

6. In the result pane of the **New ASP.NET Core Web Application** dialog box, click **Empty**, and then click **OK**.

7. In the **Solution Explorer** pane, of the **ConfigureServiceExample - Microsoft Visual Studio** window, click **Startup.cs**.

8. In the **Startup.cs** code window, delete the **Configure** method with its content.

9. In the **Startup.cs** code window, place the cursor within the **Startup** class code block,  bellow the **ConfigureServices** method, and then type the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("Hello World!");
        });
    }
```

10. In the Solution Explorer pane of the **ConfigureServiceExample - Microsoft Visual Studio** window, right-click on the **ConfigureServiceExample**, point to **Add**, and then click **New Folder**.

11.	In the Solution Explorer pane, name the newly created folder as **Services**, and then press Enter.

12. In the Solution Explorer pane, right-click **Services**, point to **Add**, and then click **Class**.

13. In the **Add New Item** dialog window, inside the **Name** box type **Logger**, and then press **Add**.

14.  In the **Logger.cs** code window, locate the following code.
```cs
    using System.Threading.Tasks;
```

15. Place the mouse cursor at the end of the code, press Enter, and then type the following code.
```cs
    using System.IO;
 ```

16. Place the mouse cursor within the **Logger** class block, press Enter, and then type the following code.
```cs
    string _fileName;
```

17. Place the mouse cursor at the end of the **_fileName** field, press Enter twice, and then type the following code.
```cs
    public Logger()
    {
    }
```

18. Place the mouse cursor within the constructor code block you just created, and then type the following code.
```cs
    _fileName = $"{DateTime.UtcNow.ToString("yyyy-dd-MM--HH-mm-ss")}.log";
```

19. Place the mouse cursor at the end of the **Logger** constructor, press Enter twice, and then type the following code.
```cs
    public void Log(string logData)
    {
        File.AppendAllText(_fileName, $"{DateTime.UtcNow}: {logData}");
    }
```

20. On the toolbar of the  **ConfigureServiceExample - Microsoft Visual Studio**  window, click  **Save Services\Logger.cs(Ctrl+S)**.

21. In the **Logger.cs** code window, locate the following code.
```cs
public class Logger
```

22. Right-click on the **Logger** class name,  click **Quick Actions and Refactorings...**, and then click **Extract Interface**.

23. In the **Extract Interface** dialog window, leave all the default values as they are, and then click **OK**.

24. In the **Solution Explorer** pane, double click the **Startup.cs**.

25. In the **Logger.cs** code window, locate the following code.
```cs
    using Microsoft.Extensions.DependencyInjection;
```

26. Place the mouse cursor at the end of the code, press Enter, and then type the following code.
```cs
    using ConfigureServiceExample.Services;
```

27. Place the mouse cursor within the **ConfigureServices** method block, press Enter, and then type the following code.
```cs
    services.AddSingleton<ILogger, Logger>();
```

28. In the **Startup.cs** code window, select the following code.
```cs
    public void Configure(IApplicationBuilder app)
```

29. Replace the code you selected with the following code.
```cs
    public void Configure(IApplicationBuilder app, ILogger log)
```

30. Inside the **Configure** method, locate the following code.
```cs
    app.Run(async (context) =>
    {
```

31. Place the mouse cursor at the end of the code, press Enter, and then type the following code.
```cs
    log.Log("Logged line");
```

32. On the **DEBUG** menu of the **ConfigureServiceExample –  Microsoft Visual Studio** window, click **Start Debugging**.

33. In the **Microsoft Edge** window, click **Close**.

34. On the **DEBUG** menu of the **ConfigureServiceExample –  Microsoft Visual Studio** window, click **Stop Debugging**

35. In the **Solution Explorer** pane, double click the newly created **XXXX-XX-XX--XX-XX-XX.log** file.
     >**Note**: An instance of the **Logger** class generated a log file and a text within it. The generated text in the file is: **[DateTime]: Logged Line**.

36. On the **FILE** menu of the **ConfigureServiceExample - Microsoft Visual Studio** window, click **Exit**.


 
