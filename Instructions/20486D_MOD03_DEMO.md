# Module 3: Configuring Middleware and Services in ASP.NET Core

# Lesson 1: Configuring Middleware

### Demonstration: How to Create Custom Middleware

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **ConfigureMiddlewareExample**.

6. In the **Location** textbox, write **Allfiles\Mod03\Democode\01_ConfigureMiddlewareExample_begin**, and then click **OK**. 

7. In the result pane of the **New ASP.NET Core Web Application - ConfigureMiddlewareExample** dialog box, click **Empty**, ensure that the check boxes are cleared, and then click **OK**.

8. In the **Solution Explorer** pane of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Startup.cs**.

9. In the **Startup.cs** code window, delete any existing comment in the file.

10. In the **Startup.cs** code window, delete the **Configure** method with its content.

11. In the **Startup.cs** code window, place the cursor within the **Startup** class code block,  below the **ConfigureServices** method, and then type the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```

12. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

13. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**. 

14. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/UrlTest1**, and then press Enter.
    >**Note**: The browser displays: "This text was generated by the app.Run middleware."

15. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/UrlTest2**, and then press Enter.
    >**Note**: The browser displays: "This text was generated by the app.Run middleware."

16. In the **Microsoft Edge** window, click **Close**.

17. On the **DEBUG** menu of the **ConfigureMiddlewareExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

18. In the **Startup.cs** code window, locate the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
```

19. Place the cursor after the { (opening brackets) sign, press Enter, type the following code, and then press Enter again.
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Request path is: " + context.Request.Path.Value + "<br />");
    });
```

20. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

21. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.

22. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/UrlTest1**, and then press Enter.
    >**Note**: The browser displays: "This text was generated by the app.Use middleware. Request path is: /UrlTest1".

23. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/UrlTest2**, and then press Enter.
    >**Note**: The browser displays: "This text was generated by the app.Use middleware. Request path is: /UrlTest2".

24. In the **Microsoft Edge** window, click **Close**.

25. On the **DEBUG** menu of the **ConfigureMiddlewareExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

26. In the **Startup.cs** code window, locate the following code:
```cs
    await context.Response.WriteAsync("This text was generated by the app.Use middleware. Request path is: " + context.Request.Path.Value + "<br />");
```

27. Place the cursor at the end of the located code, press Enter, and then type the following code:
```cs
    await next.Invoke();
```

28. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

29. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.
    >**Note**: The browser displays: <br />
						 "This text was generated by the app.Use middleware. Request path is: /  <br />
This text was generated by the app.Run middleware."

30. In the **Microsoft Edge** window, click **Close**.

31. On the **DEBUG** menu of the **ConfigureMiddlewareExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

32. In the **Startup.cs** code window, select the following code:
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Request path is: " + context.Request.Path.Value + "<br />");
        await next.Invoke();
    });
```

33. Right-click the selected code, and then click **Cut**.

34. In the **Startup.cs** code window, locate the following code:
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
    });
```

35. Place the cursor at the end of the located code, press Enter twice, right-click at the cursor location, and then click  **Paste**.

36. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

37. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.
    >**Note**: The browser displays: "This text was generated by the app.Run middleware."

38. In the **Microsoft Edge** window, click **Close**.

39. On the **DEBUG** menu of the **ConfigureMiddlewareExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

40. In the **Startup.cs** code window, select the following code:
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
    });
```

41. Right-click the selected code, and then click **Cut**.

42. In the **Startup.cs** code window, locate the following code:
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Request path is: " + context.Request.Path.Value + "<br />");
        await next.Invoke();
    });
```

43. Place the cursor at the end of the located code, press Enter twice, right-click at the cursor location, and then click **Paste**.

44. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

45. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Exit**.




# Lesson 1: Configuring Middleware

### Demonstration: How to Work with Static Files

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **StaticFilesExample**.

6.  In the **Location** textbox, write **Allfiles\Mod03\Democode\02_StaticFilesExample_begin**, and then click **OK**. 

7. In the result pane of the **New ASP.NET Core Web Application - StaticFilesExample** dialog box, click **Empty**, ensure that the check boxes are cleared, and then click **OK**.
    >**Note**: In **Solution Explorer** of the **StaticFilesExample - Microsoft Visual Studio** window, notice the **wwwroot** folder is empty.

8.  In the **File Explorer** window, go to **Allfiles\Mod03\Democode\02_StaticFilesExample_begin**.

9.  In the **02_StaticFilesExample_begin** window, select the **html-file.html** and the **image-file.jpg** files.
 
10. Right-click the selected files, and then click **Copy**.

11. In the **File Explorer** window, go to **Allfiles\Mod03\Democode\02_StaticFilesExample_begin\StaticFilesExample\StaticFilesExample\wwwroot**.
12. In the **wwwroot** window, right-click an empty space, and then click **Paste**.
    >**Note**: In the **Solution Explorer** pane of the **StaticFilesExample - Microsoft Visual Studio** window, ensure that the **wwwroot** folder contains the copied files (You might need to expand the wwwroot directory to see the files).
    
13. In the **Solution Explorer** pane of the **StaticFilesExample - Microsoft Visual Studio** window, click **Startup.cs**.

14. In the **Startup.cs** code window, delete any existing comment in the file.

15. In the **Startup.cs** code window, delete the **Configure** method with its content.

16. In the **Startup.cs** code window, place the cursor within the **Startup** class code block,  below the **ConfigureServices** method, and then type the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```
17. On the **FILE** menu of the **StaticFilesExample - Microsoft Visual Studio** window, click **Save All**.

18. On the **DEBUG** menu of the **StaticFilesExample –  Microsoft Visual Studio** window, click **Start Debugging**.

19. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/html-file.html**, and then press Enter.
    >**Note**: The browser displays "This text was generated by the app.Run middleware."

20. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/image-file.jpg**, and then press Enter.
    >**Note**: The browser displays "This text was generated by the app.Run middleware."

21. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/nonexisting-path.jpg**, and then press Enter.
    >**Note**: The browser displays "This text was generated by the app.Run middleware."

22. In the **Microsoft Edge** window, click **Close**.

23. On the **DEBUG** menu of the **StaticFilesExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

24. In **Solution Explorer**, click **Startup.cs**.

25. In the **Startup.cs** code window, locate the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
```

26. Place the cursor after the { (opening brackets) sign, press Enter, type the following code, and then press Enter again.
```cs
    app.UseStaticFiles();
```
27. On the **FILE** menu of the **StaticFilesExample - Microsoft Visual Studio** window, click **Save All**.

28. On the **DEBUG** menu of the **StaticFilesExample –  Microsoft Visual Studio** window, click **Start Debugging**.

29. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/html-file.html**, and then press Enter.
    >**Note**: The browser displays the HTML file content: "Hello From HTML File !"

30. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/image-file.jpg**, and then press Enter.
    >**Note**: The browser displays the image file.

31. In **Microsoft Edge**, in the address bar, type **http://localhost:[port]/nonexisting-path.jpg**, and then press Enter.
    >**Note**: The browser displays "This text was generated by the app.Run middleware".
     

32. In the **Microsoft Edge** window, click **Close**.

33. On the **DEBUG** menu of the **StaticFilesExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

34. On the **FILE** menu of the **StaticFilesExample - Microsoft Visual Studio** window, click **Exit**.



# Lesson 2: Configuring Services

### Demonstration: How to Use Dependency Injection

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **ConfigureServiceExample**.

6. In the **Location** textbox, write **Allfiles\Mod03\Democode\03_ConfigureServiceExample_begin**, and then click **OK**. 

7. In the result pane of the **New ASP.NET Core Web Application - ConfigureServiceExample** dialog box, click **Empty**, ensure that the check boxes are cleared, and then click **OK**.

8. In the **Solution Explorer** pane of the **ConfigureServiceExample - Microsoft Visual Studio** window, click **Startup.cs**.

9. In the **Startup.cs** code window, delete any existing comment in the file.

10. In the **Startup.cs** code window, delete the **Configure** method with it's content.

11. In the **Startup.cs** code window, place the cursor within the **Startup** class code block,  below the **ConfigureServices** method, and then type the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```

12. In the **Solution Explorer** pane of the **ConfigureServiceExample - Microsoft Visual Studio** window, right-click **ConfigureServiceExample**, point to **Add**, and then click **New Folder**.

13.	In the **NewFolder** box, type **Services**, and then press Enter.

14. In **Solution Explorer**, right-click **Services**, point to **Add**, and then click **Class**.

15. In the **Name** box of the **Add New Item – ConfigureServiceExample** dialog box, type **Logger**, and then click **Add**.

16.  In the **Logger.cs** code window, locate the following code:
```cs
    using System.Threading.Tasks;
```

17. Place the cursor at the end of the located code, press Enter, and then type the following code:
```cs
    using System.IO;
```

18. Place the cursor within the **Logger** class block, press Enter, and then type the following code:
```cs
    string _fileName;
```

19. Place the cursor at the end of the **_fileName** field, press Enter twice, and then type the following code:
```cs
    public Logger()
    {
    }
```

20. Place the cursor within the **Logger** constructor code block you just created, press Enter, and then type the following code:
```cs
    _fileName = $"{DateTime.UtcNow.ToString("yyyy-dd-MM--HH-mm-ss")}.log";
```

21. Place the cursor at the end of the **Logger** constructor, press Enter twice, and then type the following code:
```cs
    public void Log(string logData)
    {
        File.AppendAllText(_fileName, $"{DateTime.UtcNow}: {logData}");
    }
```

22. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

23. In the **Logger.cs** code window, locate the following code:
```cs
public class Logger
```

24. Right-click the **Logger** class name,  click **Quick Actions and Refactorings**, and then click **Extract Interface**.

25. In the **Extract Interface** dialog window, click **OK**.

26. In **Solution Explorer**, double click **Startup.cs**.

27. In the **Startup.cs** code window, locate the following code:
```cs
    using Microsoft.Extensions.DependencyInjection;
```

28. Place the cursor at the end of the located code, press Enter, and then type the following code:
```cs
    using ConfigureServiceExample.Services;
```

29. Place the cursor within the **ConfigureServices** method block, press Enter, and then type the following code:
```cs
    services.AddSingleton<ILogger, Logger>();
```

30. In the **Startup.cs** code window, select the following code:
```cs
    public void Configure(IApplicationBuilder app)
```

31. Replace the selected code with the following code:
```cs
    public void Configure(IApplicationBuilder app, ILogger log)
```

32. In the **Configure** method, locate the following code:
```cs
    app.Run(async (context) =>
    {
```

33. Place the cursor after the { (opening brackets) sign, press Enter, type the following code, and then press Enter again.
```cs
    log.Log("Logged line");
```
34. On the **FILE** menu of the **ConfigureServiceExample- Microsoft Visual Studio** window, click **Save All**.

35. On the **DEBUG** menu of the **ConfigureServiceExample –  Microsoft Visual Studio** window, click **Start Debugging**.
    >**Note**: The browser displays: "This text was generated by the app.Run middleware." <br/>
    In **Solution Explorer**, in the project main directory, a log file was created by the **Logger** constructor. 

36. In the **Microsoft Edge** window, click **Close**.

37. On the **DEBUG** menu of the **ConfigureServiceExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**

38. In **Solution Explorer**, double click the newly created **XXXX-XX-XX--XX-XX-XX.log** file.
    >**Note**: The text inside the log file is: "[DateTime]: Logged Line".

39. On the **FILE** menu of the **ConfigureServiceExample - Microsoft Visual Studio** window, click **Exit**.
