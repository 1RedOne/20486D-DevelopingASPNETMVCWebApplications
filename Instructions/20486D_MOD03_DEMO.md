# Module 3: Configuring Middleware and Services in ASP.NET Core

# Lesson 1: Configuring Middleware

### Demonstration: How to Create Custom Middleware

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **ConfigureMiddlewareExample**, and then click **OK**.

6. In the result pane of the **New ASP.NET Core Web Application - ConfigureMiddlewareExample** dialog box, click **Empty**, and then click **OK**.

7. In the **Solution Explorer** pane, of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Startup.cs**.

8. In the **Startup.cs** code window, delete the **Configure** method with its content.

9. In the **Startup.cs** code window, place the mosue cursor within the **Startup** class code block,  bellow the **ConfigureServices** method, and then type the following code.

```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```

10. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

11. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**. 

12. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/UrlTest1, and then press Enter.

    >**Note**: The browser displays "This text was generated by the app.Run middleware.".

13. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/UrlTest2, and then press Enter. 

    >**Note**: The browser displays "This text was generated by the app.Run middleware.".

14. In the **Microsoft Edge** window, click **Close**.

15. On the **DEBUG** menu of the **ConfigureMiddlewareExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

16. In the **Startup.cs** code window, locate the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
```

17. Place the mouse cursor after the { (opening brackets) sign, press Enter, type the following code, and then press Enter again.
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Current page URL request path = " + context.Request.Path.Value + "<br />");
    });
```
>**Note**: The value of **context.Request.Path.Value** is the value of the request path.

18. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

19. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.

20. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/UrlTest1, and then press Enter.
     >**Note**: The browser displays "This text was generated by the app.Use. URL request path = [URL request Path]".
21. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/UrlTest2, and then press Enter. 
     >**Note**: The browser displays "This text was generated by the app.Use. URL request path = [URL request  Path]".

22. In the **Microsoft Edge** window, click **Close**.

23. On the **DEBUG** menu of the **ConfigureMiddlewareExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

24. In the **Startup.cs** code window, locate the following code.
```cs
    await context.Response.WriteAsync("This text was generated by the app.Use middleware. Current page URL request path = " + context.Request.Path.Value + "<br />");
```

25. Place the mouse cursor at the end of the located code, press Enter, and then type the following code.
```cs
    await next.Invoke();
```

26. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

27. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.
     >**Note**: The browser displays a result that is generated by the **app.Use** and the app.Run. 

28. In the **Microsoft Edge** window, click **Close**.

29. On the **DEBUG** menu of the **ConfigureMiddlewareExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

30. In the **Startup.cs** code window, select the following code.
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Current page URL request path = " + context.Request.Path.Value + "<br />");
        await next.Invoke();
    });
```

31. Right-click on the selected code, and then click **Cut**.

32. In the **Startup.cs** code window, locate the following code.
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
    });
```

33. Place the mouse cursor at the end of the located code, press Enter twice, right-click at the cursor location, and then click  **Paste**.
     
34. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.
     
35. On the **DEBUG** menu of the **ConfigureMiddlewareExample –  Microsoft Visual Studio** window, click **Start Debugging**.
     >**Note**: The browser displays "This text was generated by the app.Run middleware.".

36. In the **Microsoft Edge** window, click **Close**.

37. On the **DEBUG** menu of the **ConfigureMiddlewareExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

38. In the **Startup.cs** code window, select the following code.
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
    });
```

39. Right-click the selected code, and then click **Cut**.

40. In the **Startup.cs** code window, locate the following code.
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Current page URL request path = " + context.Request.Path.Value + "<br />");
        await next.Invoke();
    });
```

41. Place the mouse cursor at the end of the located code, press Enter twice, right-click at the cursor location, and then click **Paste**.

42. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

43. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Exit**.


# Lesson 1: Configuring Middleware

### Demonstration: How to Work with Static Files

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **StaticFilesExample**.

6.  In the **Location** textbox, write **Allfiles\Mod03\Democode\02_StaticFilesExample_begin**, and then click **OK**. 

7. In the result pane of the **New ASP.NET Core Web Application - StaticFilesExample** dialog box, click **Empty**, and then click **OK**.
      >**Note**: In the **Solution Explorer** pane, of the **StaticFilesExample - Microsoft Visual Studio** window, notice the **wwwroot** folder is empty.

8.  In the **File Explorer** window, go to **Allfiles\Mod03\Democode\02_StaticFilesExample_begin**.
    
9.  In the **02_StaticFilesExample_begin** window, select the **html-file.html** and the **image-file.jpg** files.
 
10. Right-click the selected files, and then click **Copy**.
    
11.  In the **File Explorer** window, go to **Allfiles\Mod03\Democode\02_StaticFilesExample_begin\StaticFilesExample\StaticFilesExample\wwwroot**.
    
12.  In the **wwwroot** window, right-click an empty space, and then click **Paste**.
      >**Note**: In the Solution Explorer pane of the **StaticFilesExample - Microsoft Visual Studio** window, ensure that the **wwwroot** folder contains the both copied files (You might need to expand the wwwroot directory to see the files).

13. In the **Solution Explorer** pane, of the **StaticFilesExample - Microsoft Visual Studio** window, click **Startup.cs**.

14. In the **Startup.cs** code window, delete the **Configure** method with its content.

15. In the **Startup.cs** code window, place the mouse cursor within the **Startup** class code block,  bellow the **ConfigureServices** method, and then type the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```
16. On the **FILE** menu of the **StaticFilesExample - Microsoft Visual Studio** window, click **Save All**.

17. On the **DEBUG** menu of the **StaticFilesExample –  Microsoft Visual Studio** window, click **Start Debugging**.

18. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/html-file.html, and then press Enter.
     >**Note**: The browser displays "This text was generated by the app.Run middleware".

19. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/image-file.jpg, and then press Enter. 
     >**Note**: The browser displays "This text was generated by the app.Run middleware".

20. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/nonexisting-path.jpg, and then press Enter. 
     >**Note**: The browser displays "This text was generated by the app.Run middleware".

21. In the **Microsoft Edge** window, click **Close**.

22. On the **DEBUG** menu of the **StaticFilesExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**

23. In the **Solution Explorer** pane, click **Startup.cs**.

24. In the **Startup.cs** code window, locate the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
```

25. Place the mouse cursor after the { (opening brackets) sign, press Enter, type the following code, and then press Enter again.
```cs
    app.UseStaticFiles();
```
26. On the **FILE** menu of the **StaticFilesExample - Microsoft Visual Studio** window, click **Save All**.

27. On the **DEBUG** menu of the **StaticFilesExample –  Microsoft Visual Studio** window, click **Start Debugging**.

28. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/html-file.html, and then press Enter.
     >**Note**: The browser displays the HTML file content.

29. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/image-file.jpg, and then press Enter. 
     >**Note**: The browser displays the image file.

30. In the **Microsoft Edge** window, Change the URL path to http://localhost:[port]/nonexisting-path.jpg, and then press Enter. 
     >**Note**: The UseStaticFiles middleware cannot find a file by the supplied request path, and calls the next middleware in the pipline. The next middleware is **app.Run**. Therefore the browser displays "This text was generated by the app.Run middleware".
     

31. In the **Microsoft Edge** window, click **Close**.

32. On the **DEBUG** menu of the **StaticFilesExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**.

33. On the **FILE** menu of the **StaticFilesExample - Microsoft Visual Studio** window, click **Exit**.

# Lesson 2: Configuring Services

### Demonstration: How to Use Dependency Injection

#### Preparation Steps 

1. Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for this course's labs and demos. https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles.


#### Demonstration Steps

1. Start **Visual Studio 2017**.

2. On the **FILE** menu of the **Start Page - Microsoft Visual Studio** window, point to **New**, and then click **Project**.

3. In the navigation pane of the **New Project** dialog box, expand **Installed**, and then click **Visual C#**.

4. In the result pane of the **New Project** dialog box, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **ConfigureServiceExample**, and then click **OK**.

6. In the result pane of the **New ASP.NET Core Web Application - ConfigureServiceExample** dialog box, click **Empty**, and then click **OK**.

7. In the **Solution Explorer** pane of the **ConfigureServiceExample - Microsoft Visual Studio** window, click **Startup.cs**.

8. In the **Startup.cs** code window, delete the **Configure** method with it's content.

9. In the **Startup.cs** code window, place the mouse cursor within the **Startup** class code block,  bellow the **ConfigureServices** method, and then type the following code.
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```

10. In the Solution Explorer pane of the **ConfigureServiceExample - Microsoft Visual Studio** window, right-click the **ConfigureServiceExample**, point to **Add**, and then click **New Folder**.

11.	In the **NewFolder** box, type **Services**, and then press Enter.

12. In the Solution Explorer pane, right-click **Services**, point to **Add**, and then click **Class**.

13. In the **Name** box of the **Add New Item – ConfigureServiceExample** dialog box, type **Logger.cs**, and then click **Add**

14.  In the **Logger.cs** code window, locate the following code.
```cs
    using System.Threading.Tasks;
```

15. Place the mouse cursor at the end of the located code, press Enter, and then type the following code.
```cs
    using System.IO;
```

16. Place the mouse cursor within the **Logger** class block, press Enter, and then type the following code.
```cs
    string _fileName;
```

17. Place the mouse cursor at the end of the **_fileName** field, press Enter twice, and then type the following code.
```cs
    public Logger()
    {
    }
```

18. Place the mouse cursor within the **Logger** constructor code block you just created, press Enter, and then type the following code.
```cs
    _fileName = $"{DateTime.UtcNow.ToString("yyyy-dd-MM--HH-mm-ss")}.log";
```

19. Place the mouse cursor at the end of the **Logger** constructor, press Enter twice, and then type the following code.
```cs
    public void Log(string logData)
    {
        File.AppendAllText(_fileName, $"{DateTime.UtcNow}: {logData}");
    }
```

20. On the **FILE** menu of the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, click **Save All**.

21. In the **Logger.cs** code window, locate the following code.
```cs
public class Logger
```

22. Right-click the **Logger** class name,  click **Quick Actions and Refactorings...**, and then click **Extract Interface**.

23. In the **Extract Interface** dialog window, and then click **OK**.

24. In the **Solution Explorer** pane, double click **Startup.cs**.

25. In the **Logger.cs** code window, locate the following code.
```cs
    using Microsoft.Extensions.DependencyInjection;
```

26. Place the mouse cursor at the end of the located code, press Enter, and then type the following code.
```cs
    using ConfigureServiceExample.Services;
```

27. Place the mouse cursor within the **ConfigureServices** method block, press Enter, and then type the following code.
```cs
    services.AddSingleton<ILogger, Logger>();
```

28. In the **Startup.cs** code window, select the following code.
```cs
    public void Configure(IApplicationBuilder app)
```

29. Replace the selected code with the following code.
```cs
    public void Configure(IApplicationBuilder app, ILogger log)
```

30. In the **Configure** method, locate the following code.
```cs
    app.Run(async (context) =>
    {
```

31. Place the mouse cursor after the { (opening brackets) sign, press Enter, and then type the following code.
```cs
    log.Log("Logged line");
```
32. On the **FILE** menu of the **ConfigureServiceExample- Microsoft Visual Studio** window, click **Save All**.

33. On the **DEBUG** menu of the **ConfigureServiceExample –  Microsoft Visual Studio** window, click **Start Debugging**.
     >**Note**: The browser displays "XXX". <br/>
    In the **Solution Explorer** pane, in the project main directory, a log file created by the **Logger** constructor. 

34. In the **Microsoft Edge** window, click **Close**.

35. On the **DEBUG** menu of the **ConfigureServiceExample  (Running) –  Microsoft Visual Studio** window, click **Stop Debugging**

36. In the **Solution Explorer** pane, double click the newly created **XXXX-XX-XX--XX-XX-XX.log** file.
     >**Note**: An instance of the **Logger** class generated a log file and a text within it. The generated text in the file is: "[DateTime]: Logged Line".

37. On the **FILE** menu of the **ConfigureServiceExample - Microsoft Visual Studio** window, click **Exit**.


 
