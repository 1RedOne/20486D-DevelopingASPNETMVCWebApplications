# Module 3: Configuring Middleware and Services in ASP.NET Core

# Lab: Configuring Middleware and Services in ASP.NET Core

#### Scenario
The Adventure Works Company wants to develop a website about ball games. For this, the company needs to perform a survey to determine the popularity of different ball games. As their employee, you are required to create a survey site to be used by the company.

#### Objectives

After completing this lab, you will be able to:

-	Use ASP.NET Core static files including HTML files, image files and CSS files.
-	Create and use a custom middleware and use its context information.
-	Create and use services with ASP.NET Core built-in Dependency Injection.
-	Inject a service to an ASP.NET Core MVC controller.

#### Lab Setup

Estimated Time: **75 minutes**

### Exercise 1: Working with Static Files

#### Scenario

To create the poll, the application needs a styled HTML page. The HTML page must then post the poll results to the server. To transfer the results to the server you will use an HTML form.

The main tasks for this exercise are as follows: 

1.	Create a new project by using the ASP.NET Core Empty project template.

2.	Run the application.

3.	Add an HTML file to the wwwroot folder.

4.	Run the application – content of HTML not displayed.

5.	Enable working with static files.

6.	Run the application – content of HTML is displayed.

7.	Add an HTML file outside of the wwwroot folder.

8.	Run the application – content of HTML outside wwwroot folder not displayed.

####	Task 1: Create a new project using the ASP.NET Core Empty project template

1. Open **Visual Studio 2017** and create a new **ASP.NET Core Web Application** using the following information:

    - Name: **PollBall**
    - Location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Solution name: **PollBall**
    - Create directory for solution: **True**
    - Project template: **Empty**
    - Configure for HTTPS: **False**

2. Delete all the comments in **Startup.cs**.

3. In **Startup.cs**, delete the **Configure** method with its content.

4. In **Startup.cs**, add a method using the following information:
    - Scope: **public**
    - Return Type: **void**
    - Name: **Configure**
    - Parameter Type: **IApplicationBuilder**
    - Parameter Name: **app**

5. In the **Configure** method, add an **app.Run** middleware so the browser would display the following text:<br>
"This text was generated by the app.Run middleware."

####	Task 2: Run the application

1. Save all the changes.

2. Start debugging the application.
 
3. Verify that the browser displays the following text: "This text was generated by the app.Run middleware."

4. Stop debugging.

####	Task 3: Add an HTML file to the wwwroot folder

1. Create a new subfolder using the following information:
    - Folder name: **css**
    - Parent directory: **wwwroot**

2. Copy a CSS file to the new **css** folder using the following information:
    - File name: **style.css**
    - Source location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location:  **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot\css**

3. Copy the **images** folder using the following information:
    - Source location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location: **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot** 

4. Create a new **HTML Page** using the following information:
    - Parent Directory: **wwwroot**
    - File name: **poll-questions.html**

5. Inside the **BODY** element, create a **P** element.

6. Inside the **P** element, create an **H1** element with the following text: "Favorite ball game poll."

7. In the **P** element, below the **H1** element, write the following text: <br />
"Please select your favorite ball game and then press submit.<br />
The poll is anonymous and does not contain names."

8. Below the **P** element, add a **FORM** element with the class name **submit-form**.

9. Inside the **FORM** element, create a **DIV** element with the class name **main-div**.

10. Below the **DIV** element, create another **DIV** element with the class name **submit-batch**.

11. Inside the **DIV** element with the class name **submit-batch**, add an **input** element using the following information:
    - Input type: **submit**
    - Value: **Submit Query**

12. Copy the content from the **html-text.txt** file using the following information:
    - File path: **Allfiles\Mod03\Labfiles\01_PollBall_begin**

13. In the **poll-questions.html** of the **PollBall** application, paste the text into the **DIV** element with the **main-div** class name.

####	Task 4: Run the application – content of HTML not displayed

1. Save all the changes.

2. Start debugging the application.

3. Access the following relative path:
    - Path: **/poll-questions.html**

4. Verify that the browser displays the following text:<br>
"This text was generated by the app.Run middleware."

5. Stop debugging.

####	Task 5: Enable working with static files

1. In **Startup.cs**, in the **Configure** method code block, add the **UseStaticFiles** method call to be first middleware in the pipeline.

####	Task 6: Run the application – content of HTML is displayed

1. Save all the changes.

2. Start debugging the application.

3. Access the following relative path:
    - Path: **/poll-questions.html**

4. Verify that the browser displays the **poll-questions.html** file content.

5. Stop debugging.

6. In the **poll-questions.html** file,In the **HEAD** element, 
add a **LINK** element using the following information:
    - Type: **text/css**
    - Relation: **stylesheet**
    - Href: **css/style.css**

7. Save all the changes.

8. Start debugging the application.

9. Access the following relative path: 
    - Path: **/poll-questions.html**

10. Verify that the browser display the **poll-questions.html** content designed by the **style.css**.

11. Stop debugging. 


####	Task 7: Add an HTML file outside of the wwwroot folder

1. Copy an HTML file to a new location using the following information:
    - File name: **test.html**
    - Source location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location: **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall**

####	Task 8: Run the application – content of HTML outside wwwroot folder not displayed

1. Save all the changes.

2. Start debugging the application.

3. Access the following relative path:
    - Path: **/test.html**

4. Verify that the browser displays the following text:<br>
"This text was generated by the app.Run middleware."

5. Stop debugging. 

>**Result**: At the end of this exercise, you will be able to add and work with static files inside an **ASP.NET Core** project.

### Exercise 2: Creating Custom Middleware

#### Scenario

The server must receive the client’s request and notify the company of the poll submission.

The main tasks for this exercise are as follows: 

1. Create a middleware.

2. Run the application.

3. Change the order of middleware.

####	Task 1: Create a middleware

1. In **Startup.cs**, Create an **app.Use** custom middleware inside the **Configure** method, as the first middleware in the pipeline.

2. In **app.Use**, write a code to check the existence of the "favorite" query parameter in the request that  is submitted by the **HTML** form.

3. If the "favorite" query parameter does not exist in the request, invoke the next middleware in the pipeline.

4. If the "favorite" query parameter exists in the request, define a new variable using the following information:
    - Type: **string**
    - Name: **selectedValue**
    - Value: The value of the "favorite" query parameter

5. If the "favorite" query parameter exists in the request, call the **WriteAsync** method so the browser would display a text using the following information:
    - Text: **"Selected Value is: "** concatenated with the **selectedValue** variable.

####	Task 2: Run the application

1. Save all the changes.

2. Start debugging the application.

3. Access the following relative path:
    - Path: **/poll-questions.html**

4. Select **Basketball**, and click **Submit Query**.

5. Verify that the browser displays the following text:<br>
"Selected Value is: basketball"

6. Stop debugging. 

####	Task 3: Change the order of middleware

1. Relocate the **app.UseStaticFiles** method call to be the first middleware in the pipeline.

2. Save all the changes.

3. Start debugging the application.

4. Access the following relative path:
    - Path: **/poll-questions.html**

5. Select **Basketball**, and click **Submit Query**.

6. Verify that the browser displays the **poll-questions.html** file content.
    > **Note**: The **use.StaticFiles** middleware handles the request. The request does not continue to the **app.Use** middleware.

7. Stop debugging. 

8. Relocate the **app.UseStaticFiles** to be between the **app.Use** middleware and the **app.Run** middleware.

9. Comment out the code that would run in case the "favorite" query parameter does not exist.

10. Save all the changes.

11. Start debugging the application.

12. Access the following relative path:
    - Path: **/poll-questions.html**

13. Verify that the browser displays a blank page.

14. Stop debugging. 

15. Uncomment the code that present the case that the "favorite" query parameter does not exist.

>**Result**: At the end of this exercise, you will be able to create a custom middleware and receive HTML form calls to it.

### Exercise 3: Using Dependency Injection

#### Scenario

You will need to aggregate the votes and store them for future use. You will use services to manage and preserve the data.

The main tasks for this exercise are as follows: 

1. Define an interface for a service.

2.	Define an implementation for the service.

3.	Use Dependency Injection.

4.	Run the application.

####	Task 1: Define an interface for a service

1. Create a new top-level folder, in the **PollBall** project using the following information:
    - Folder name: **Services**

2. Create a new **enum** using the following information:
    - Parent folder: **Services**
    - Name: **SelectedGame**

3. Fill the **enum** with the following values:

    - Basketball
    - Football
    - Soccer
    - Vollyball
    - Billiard
    - Hockey
    - Golf
    - Tennis


4. Create a new interface using the following information:
    - Parent folder: **Services**
    - Name: **IPollResultsService**

5. Add a method declaration inside the interface using the following information:
    - Return type: **void**
    - Name: **AddVote**
    - Parameter name: **game**
    - Parameter Type: **SelectedGame**

6. Add a method declaration inside the interface using the following information:
    - Name: **GetVoteResult**
    - Return type: **SortedDictionary**<**SelectedGame**,**int**>

7. Set **public** scope to the new interface.

####	Task 2: Define an implementation for the service

1. Create a new class using the following information:
    - Parent folder: **Services**
    - Name: **PollResultsService**

2. Alter the **PollResultsService** class definition, so that **PollResultsService** would be an implementation of **IPollResultsService** interface.

3. In the **PollResultsService** class, create a property that will contain the vote counts per game using the following information:
    - Scope: **private**
    - Type: **Dictionary**<**SelectedGame**,**int**>
    - Name: **SelectionVotes**
    - Access: **Read/Write**

4. Add a new public constructor to the **PollResultsService** class. In the constructor, instantiate **SelectionVotes** to be a new **Dictionary**<**SelectedGame**,**int**> object.

5. Implement the **AddVote** method from the **IPollResultsService** interface. The method should increment the value of the dictionary's selected game, using the given game parameter value as it's key. In case the key does not exist, add a new key to the dictionary with the value of 1.

6. In the **PollResultsService** class, implement the **GetVoteResult** method from the **IPollResultsService** interface. The method should return a new **SortedDictionary** instantiated with **SelectionVotes** passed to its constructor.

####	Task 3: Use dependency injection

1. In **Startup.cs**, Add **using** statements for the following namespaces:
    - **PollBall.Services**

2. Modify the **Configure** method to include the following parameters:
    - First parameter type: **IApplicationBuilder**
    - First parameter name: **app**
    - Second parameter type: **IHostingEnvironment**
    - Second parameter name: **env**
    - Third parameter type: **IPollResultsService**
    - Third parameter name: **pollResults**

3. In the **Configure** method, replace the text in the **app.Run** to a new text using the following information:
    - Text: **"This text was generated by the app.Run middleware. wwwroot folder path: "** Concatenated with the **env.WebRootPath** property.

4. In the **app.Use**, between the initialization of the **selectedValue** variable and the **WriteAsync** method call, parse the **selectedValue** variable and return the result into the **selectedGame** variable using the following information:
    - Result variable type: **SelectedGame**
    - Result variable name: **selectedGame**
    - Method call: **Enum.Parse**
    - Enum type: **SelectedGame**
    - Variable name to parse: **selectedValue**
    - Ignore case sensitive: **true**

5. In the **app.Use**, below the initialization of the **selectedGame** variable, execute the **AddVote** method of the **IPollResultsService** service using the following information:
    - Parameter value: **selectedGame**

6. In the **app.Use**, below the call to **AddVote**, define a new variable using the following information:
    - Type: **SortedDictionary<SelectedGame, int>**
    - Name: **gameVotes**

7. In the **app.Use**, replace the **WriteAsync** method call, with code that receives the result from the **GetVoteResult** method of the **lPollResultsService** service, and places it into the **gameVotes** variable.

8. In the **app.Use**, when the "favorite" query parameter exists, below the **GetVoteResult** method call, print to the browser each of the games names, and vote count from the **gameVotes** variable using the **WriteAsync** method. Include the game name and votes of each iteration in a **DIV** element.

9. In the **Startup** class, in the **ConfigureServices**, add the poll results service using the following information: 
    - Add method: **Singleton**
    - Interface: **IPollResultsService**
    - Implementation: **PollResultsService**


####	Task 4: Run the application

1. Save all the changes.

2. Start debugging the application.

3. Verify that the browser displays the following text:<br>
"This text was generated by the app.Run middleware. wwwroot folder path: [local path to your wwwroot folder]".

4. Access the following relative path:
    - Path: **/poll-questions.html**

5. Select **Basketball**, and click **Submit Form**.

6. Verify that the browser displays the following text:<br>
"Game name: Basketball, Votes: 1"

7. Access the following relative path:
    - Path: **/poll-questions.html**

8. Select **Football**, and click **Submit Form**.

9. Verify that the browser displays the following text:<br>
"Game name: Basketball, Votes: 1<br>
Game name: Football, Votes: 1"

10. Access the following relative path:
    - Path: **/poll-questions.html**

11. Select **Basketball**, and click **Submit Form**.

12. Verify that the browser displays the following text:<br>
"Game name: Basketball, Votes: 2<br>
Game name: Football, Votes: 1"

13. Stop debugging.

>**Result**: At the end of this exercise, you will be able to create and use a service with **Dependency Injection**.

### Exercise 4: Injecting a Service to a Controller

#### Scenario

In this exercise, you will create an ASP.NET Core MVC controller to display the poll results. 

The main tasks for this exercise are as follows: 

1.	Enable working with MVC.

2.	Add a controller.

3.	Run the application.

4.	Use Dependency Injection in a controller.

5.	Run the application.


####	Task 1: Enable working with MVC

1. In **Startup.cs**, in the **Configure** method, invoke the **UseMvcWithDefaultRoute** method between the **UseStaticFiles** and the **app.Run** middleware.

2. In **Startup.cs**, in the **ConfigureServices** method, invoke the **AddMVC** method.

####	Task 2: Add a controller

1. Create a new top-level folder, in the **PollBall** project using the following information:
    - Folder name: **Controllers**

2. Create a new controller using the following information:
    - Controller name: **HomeController**
    - Template: **MVC controller - Empty**
    - Folder: **Controllers**

3. Change the index action return value using the **Content** method with the following information:
    - Content value: **"Hello from controller"**

####	Task 3: Run the application

1. Save all the changes.

2. Start debugging the application.

3. Verify that the browser displays the following text: "Hello from controller".

4. Stop debugging. 

5. In **Startup.cs**, relocate the **app.Run** to be first middleware in the pipeline.

6. Save all the changes.

7. Start debugging the application.
    > **Note**: The browser displays: "This text was generated by the app.Run middleware. wwwroot folder path:" [local path to your wwwroot folder]."<br />

8. Stop debugging. 

9. In **Startup.cs**, move the **app.Run** block to be the last code block in the **Configure** method. 

####	Task 4: Use Dependency Injection in a controller

1. In **Startup.cs**, in the **app.Use** delete the code that is responsible for getting the vote results from the service, and displaying it in the browser.

2. Replace the deleted code with a call to the **WriteAsync** method so the browser would display a text using the following information:
    - Text: **"Thank you for submitting the poll."**

3. In **HomeController.cs**, add **using** statements for the following namespaces:
    - **PollBall.Services**
    - **System.Text**

4. In the **HomeController** class, define a new field using the following information:
    - Type: **IPollResultsService**
    - Name: **_pollResults**
    - Scope: **private**

5. In the **HomeController** class, create a public constructor, inject the **IPollResultsService** into the constructor, and save the **IPollResultsService** value into the **_pollResults** variable.

6. In **HomeController.cs**, delete the content of the **index** action.

7. In the **index** action, define and initiate a new variable using the following information:
    - Type: **StringBuilder**
    - Name: **results**
    - Value: new **StringBuilder** instance

8. In the **index** action, define and initiate a new variable using the following information:
    - Type: **SortedDictionary<SelectedGame, int>**
    - Name: **voteList**
    - Value: Call the **GetVoteResult** method of the **_pollResults** field

9. Below the **voteList** variable declaration, use a **foreach** loop to iterate over each game name and vote count, and then concatenate those into the **results** variable. Using **StringBuilder**'s  **Append** method, append the text in each iteration, and then append **Environment.NewLine**.

10. In the **index** action, return a string content using the following information:
    - method call: **Content**
    - Content value:  The **results** variable as string.

####	Task 5: Run the application

1. Save all the changes.

2. Start debugging the application.

3. Access the following relative path:
    - Path: **/poll-questions.html**

4. Select **Basketball**, and click **Submit Form**.

5. Verify that the browser displays the following text:<br>
"Thank you for submitting the poll."

6. Access the following relative path:
    - Path: **/poll-questions.html**

7. Select **Football**, and click **Submit Form**.

8. Verify that the browser displays the following text:<br>
"Thank you for submitting the poll."

9. Access the following relative path:
    - Path: **/poll-questions.html**

10. Select **Basketball**, and click **Submit Form**.

11. Verify that the browser displays the following text:<br>
"Thank you for submitting the poll."

12. Access the following relative path:
    - Path: **/**

13. Verify that the browser displays the following text:<br>
"Game name: Basketball, Votes: 2 <br> 
Game name: Football, Votes: 1"

14. Stop debugging.

>**Result**: At the end of this exercise, you will be able to create controller, and inject a service into it with **Dependency Injection**. 
