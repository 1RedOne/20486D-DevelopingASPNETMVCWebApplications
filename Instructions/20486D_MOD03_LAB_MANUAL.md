# Module 3: Configuring Middleware and Services in ASP.NET Core

# Lab: Configuring Middleware and Services in ASP.NET Core

#### Scenario
The Adventure Works Company wants to develop a web site about ball games. For this, the company needs to perform a survey to determine the popularity of different ball games. As their employee you are required to create a survey site to be used by the company.

#### Objectives

After completing this lab, you will be able to: 

-	Use ASP.NET Core static files including HTML files, image files and CSS files
-	Create and use a custom Middleware, and use its context information
-	Create and use services with ASP.NET Core built-in Dependency Injection
-	Inject services to an ASP.NET Core MVC controller

#### Lab Setup

Estimated Time: **75 minutes**

### Exercise 1: Working with Static Files

#### Scenario

To create the poll, the application needs a styled HTML page. The HTML page must then post the poll results to the server. To transfer the results to the server we will use an HTML form.

The main tasks for this exercise are as follows: 

1.	Create a new project using the ASP.NET Core Empty project template

2.	Run the application

3.	Add an HTML file to the wwwroot folder

4.	Run the application – content of HTML not displayed

5.	Enable working with static files

6.	Run the application – content of HTML is displayed

7.	Add an HTML file outside of the wwwroot folder

8.	Run the application – content of HTML outside wwwroot folder not displayed

####	Task 1: Create a new project using the ASP.NET Core Empty project template.

1. Open Visual Studio 2017 and create a new ASP.NET Core Web Application by using the following information:
-   Name:  **PollBall**
-   Location:  **Allfiles\Mod03\Labfiles\01_PollBall_begin**
-   Solution name:  **PollBall**
-   Create directory for solution: **True**
-   Project template:  **Empty**

2. Delete all the comments in the **Startup** class.

3. In the **Startup.cs** class, delete the **Configure** method with its content.

4. Add a method for the **Startup** class by using the following information:
-   Scope: **public**
-   Return Type: **void**
-   Name: **Configure**
-   Parameter Type: **IApplicationBuilder**
-   Parameter Name: **app**

5. Add an **app.Run** middleware within the **Configure** method that displays the "This text was generated by the app.Run middleware." text into the browser.

####	Task 2: Run the application.

1.  Start the  **PollBall**  project with debugging.
    
2.  Verify that "This text was generated by the app.Run middleware."" is displayed in the browser.

3.  Stop debugging.

####	Task 3: Add an HTML file to the wwwroot folder.

1. Create a new subfolder, and copy a CSS file to the new folder by using the following information:
     -   Parent directory of the new directory: **wwwroot**
     -   New folder name: **css**
     -   CSS file to be copied: **style.css**
     -   Source location of the CSS file: **Allfiles\Mod03\Labfiles\01_PollBall_begin**

2. Copy the **images** folder from the **Allfiles\Mod03\Labfiles\01_PollBall_begin** path to the  project's **wwwroot** folder.

3. Create a new **HTML Page** by using the following information:
     -   File name: **poll-questions.html**
     -   Parent Directory: **wwwroot**

4. Inside the **BODY** element, Create a **P** with the following text:

5. Fill the H1 with the following text: "Please select your favorite ball game and then press submit.
        The poll is anonymouse and does not contain names."

6. Inside the **P** element above the text, create an **H1** element with the following text: "Favorite ball game poll"

6. Add a **FORM** element to the **BODY** element, below the **P** element, with a class named **submit-form**.

7. Create a **DIV** element inside the **FORM** element with a class named **main-div**.

8. Create another **DIV** element inside the **FORM** element with a class named **submit-batch**.

9. Inside the **submit-batch** **DIV** element, add an **input** tag by using the following information:
    - Input type: **submit**
    - Value: **Submit Query**

10. Inside the **submit-batch** **DIV** element create a button of type **SUBMIT**.

11. Open the **Allfiles\Mod03\Labfiles\01_PollBall_begin\html-text.txt** existing file and copy the content into the **DIV** with the **main-div** class you created. 

####	Task 4: Run the application – content of HTML not displayed.

1.  Start the  **PollBall**  project with debugging.

2. Access the following relative URL:
     - **/poll-questions.html**

3.  Verify that "This text was generated by the app.Run middleware" is displayed in the browser.

4.  Stop debugging.

####	Task 5: Enable working with static files.

1. In the **Startup** class,  add the **UseStaticFiles** method call as the first action of the **Configure** method.

####	Task 6 : Run the application – content of HTML is displayed.

1.  Start the  **PollBall**  project with debugging.

2. Access the following relative URL:
     - **/poll-questions.html**

3.  Verify that the **poll-questions.html** file content is displayed in the browser.

4.  Stop debugging.

5. To link the new style sheet, add a  **link**  element to the  **poll-questions.html**  file by using the following information:
-   Type:  **text/css**
-   Relation:  **stylesheet**
-   Href:  **~/css/style.css**

6. Run the new ASP.NET Core application in **Microsoft Edge** and review the page's output.

7.  Start the  **PollBall**  project with debugging.

8. Access the following relative URL: 
     - **/poll-questions.html**

9.  Verify that the **poll-questions.html** file content is displayed in the browser with design from the **style.css** file.

10.  Stop debugging. 

####	Task 7: Add an HTML file outside of the wwwroot folder.

1. Copy the **test.html** file from the **Allfiles\Mod03\Labfiles\01_PollBall_begin** path to the **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall** path.

####	Task 8: Run the application – content of HTML outside wwwroot folder not displayed.

1.  Start the  **PollBall**  project with debugging.

2. Access the following relative URL:
     - **/test.html**

3.  Verify that the "This text was generated by the app.Run middleware" is displayed in the browser.

4.  Stop debugging. 

>**Result**: At the end of this exercise, you will be able to add and work with static files inside an ASP.NET Core project.

### Exercise 2: Creating Custom Middleware

#### Scenario

The server must receive the client’s request and notify the company for the poll submission.

The main tasks for this exercise are as follows: 

1. Create a middleware

2. Run the application

3. Change the order of middleware

####	Task 1: Create a middleware.

1. Create an **app.Use** custom middleware insider the **Configure** method, as the first middleware in the pipeline.

2.  In the **app.Use**, check the existance of the **favorite** parameter in the request that is submitted from the HTML form.

3. If the **favorite** parameter does not exist in the request, invoke the next middleware in the pipeline.

4. Define a new variable using the following information:
      - Type: **string**
      - Name: **selectedValue**

5. If the **favorite** parameter exist in the request, save the value in the **selectedValue** variable, and print it to the browser using **WriteAsync**.


####	Task 2: Run the application.

1.  Start the  **PollBall**  project with debugging.

2. Access the following relative URL:
     - **/poll-questions.html**

3. Select the **Basketball**  radio button, and click the **Submit Query** button.

4.  Verify that the **Selected Value is = Basketball** text is displayed in the browser.

5.  Stop debugging. 

####	Task 3: Change the order of middleware.

1. Move the **app.UseStaticFiles** before the custom middleware.

2.  Start the  **PollBall**  project with debugging.

3. Access the following relative URL:
     - **/poll-questions.html**

4. Select the **Basketball** radio button, and click the **Submit Query** button.

5.  Verify that the **poll-questions.html** file content is displayed in the browser, and that the browser did not load a different page.

6.  Stop debugging. 

7. Move the **app.UseStaticFiles** between the **app.Use** middleware and the **app.Run**.

8. Comment the **next.Invoke();** method call that invokes the next middleware in the pipeline.

9.  Start the  **PollBall**  project with debugging.

10. Access the following relative URL:
     - **/poll-questions.html**

11.  Verify that a blank page is displayed.

12.  Stop debugging. 

13. Uncomment the **next.Invoke();** method call.

>**Result**: At the end of this exercise, you will be able to create a custom middleware and receive HTML form calls to it.

### Exercise 3: Using Dependency Injection

#### Scenario

We need to aggregate the votes and store them for future use. We will use services in order to manage and preserve the data.

The main tasks for this exercise are as follows: 

1. Define an interface for a service

2.	Define an implementation for the service

3.	Use dependency injection

4.	Run the application

####	Task 1:  Define an interface for a service.

1. Create a new top-level folder, in the  **PollBall**  project by using the following information:
-   Folder name:  **Services**

2. Create a new enum by using the following information:
-   Name:  **SelectedGame**
-   Parent folder:  **Services**

3. Fill the enum with the following values:
```cs
    Basketball,
    Football,
    Soccer,
    Vollyball,
    Billiard,
    Hockey,
    Golf,
    Tennis
```

4. Create a new interface by using the following information:
-   Name:  **lPollResultsService**
-   Parent folder:  **Services**

5. Add a method declaration inside the interface using the following information:
     - Name: **AddVote**
     - Parameter name: **game**
     - Parameter Type: **SelectedGame**
     - Return type: **void**

5. Add a method declaration inside the interface using the following information:
     - Name: **GetVoteResult**
     - Return type: **SortedDictionary**<**SelectedGame**,**int**>

6. Set public scope to the new interface.

####	Task 2: Define an implementation for the service.

1. Create a class with the name **PollResultsService** inside the **Services** folder.

2.  Ensure that the **PollResultsService** class implements the **IPollResultsService** interface.

3. Create a dictionary that will contain the vote counts per game using the following information:
     - Name: **SelectionVotes**
     - Return type: **SortedDictionary**<**SelectedGame**,**int**>
     - Scope: **private**
     - Access:  **Read/Write**


5. In the **PollResultsService** class, implement the **AddVote** method from the **IPollResultsService** interface. The method should increment the value by 1 of the dictionary's selected game using the given **game** parameter value as it's key.

6. In the **PollResultsService** class, implement the **GetVoteResult** method from the **IPollResultsService** interface. The method should return a new SortedDictionary instantiated with **SelectionVotes** passed to its contructor.

####	Task 3: Use dependency injection.

1. In the **Startup** class, Add **using** statements for the following namespaces:
     - **PollBall.Services;**

2. Modify the **Configure** method so it will include the following injected services as parameters:
     - Parameter type: **lPollResultsService**
     - Parameter name: **app**
     - Parameter type: **IHostingEnvironment**
     - Parameter name: **env**
     - Parameter type: **IPollResultsService**
     - Parameter name: **pollResults**
   
3. Inject the **lPollResultsService** interface into the **Configure** method that is inside the **Startup** class using Dependency Injection.

4. In the **Configure** method, replace the text that is printed from the **app.Run ** to 
"This text was generated by the app.Run middleware. wwwroot folder path: ". Concatinate the string with a value from the **env.WebRootPath** property.

5. In the **app.Use**, parse the **selectedValue** value using the following information:
      - Method call: **Enum.Parse**
      - Enum type: **SelectedGame**
      - Ignore case sensitive: **true**
      - Varable name as result: **selectedGame**

6. Call the **AddVote** method of the **lPollResultsService** service using the following information:
      - Parameter value: **selectedGame**

7. In the custom middleware, Add a vote to the service by the selected game that is received from the **favorite** parameter. 

8. Define a new variable using the following information:
      - Type: **SortedDictionary<SelectedGame, int>**
      - Name: **gameVotes**

9. In the **app.Use** replace the **WriteAsync** method call with code that receives the **GetVoteResult** result from the **lPollResultsService** service, and places it into the **gameVotes** variable.

10. In the **app.Use**, below the **GetVoteResult** method call, print to the browser each of the games names, and vote count from the  **gameVotes** variable.

12. In the **Startup** class, in the **ConfigureServices**, add the poll results service using the following information:
     - Interface: **lPollResultsService**
     - Implementation: **PollResultsService**
     - Add method: **Singleton**

####	Task 4: Run the application.

1. Start the  **PollBall**  project with debugging.

2.  Verify that the **This text was generated by the app.Run middleware. wwwroot folder path:** [local path to your wwwroot folder]** text is displayed in the browser.

3. Access the following relative URL:
     - **/poll-questions.html**

4. Select the **Basketball**  radio button, and click the **Submit Form** button.

5.  Verify that the following text is displayed in the browser:
**Game name: Basketball, Votes: 1.**<br>

6. Access the following relative URL:
     - **/poll-questions.html**

7. Select the **Football**  radio button, and click the **Submit Form** button.

8.  Verify that the following text is displayed in the browser:
**Game name: Basketball, Votes: 1** <br> 
**Game name: Football, Votes: 1**

9. Access the following relative URL:
     - **/poll-questions.html**

10. Select the **Basketball**  radio button, and click the **Submit Form** button.

11.  Verify that the following text is displayed in the browser:
**Game name: Basketball, Votes: 2** <br> 
**Game name: Football, Votes: 1**

12.  Stop debugging.  

>**Result**: At the end of this exercise, you will be able to create and use a service with **Dependency Injection**.

### Exercise 4: Injecting a Service to a Controller

#### Scenario

We need to create a page to show results without submitting a vote.
In this case we will use an MVC controller to show the results.

The main tasks for this exercise are as follows: 

1.	Enable working with MVC

2.	Add a controller

3.	Run the application

4.	Use Dependency Injection in a controller

5.	Run the application


####	Task 1: Enable working with MVC.

1. In the **ConfigureServices** method of the **Startup** class, invoke the **AddMVC** method.

2. In the **Configure** method of the **Startup** class, invoke the **UseMvcWithDefaultRoute** method between the **UseStaticFiles** and the **app.Run** middleware.

####	Task 2: Add a controller.

1. Create a new top-level folder, in the  **PollBall**  project by using the following information:
-   Folder name:  **Controllers**

1. Create a new controller using the following information:
-   Controller name:  **HomeController**
-   Template:  **MVC controller - Empty**
-   Folder:  **Controllers**

2. Verify the the index action returns a content with the text **Hello from controller**.

####	Task 3: Run the application.

1. Start the  **PollBall**  project with debugging.

2.  Verify that the **Hello from controller** text is displayed in the browser.

3.  Stop debugging. 

4. In the **Startup** class, move the **app.Run** code block **above** the **app.Use** middleware.

5. Run the new ASP.NET Core application in **Microsoft Edge**.
     > **Note**: The **app.Run** middleware generates the following text that is displayed in the browser: "This text was generated by the app.Run middleware. wwwroot folder path:" [local path to your wwwroot folder].

6. Close the **Microsoft Edge** window.

7. In the **Startup** class, move the **app.Run** block to be the last code block in the **Configure** method.

####	Task 4: Use Dependency Injection in a controller.

1. In the **Startup** class, in the **app.Use** delete the code that is responsible for getting the vote results from the service, and displaying it in the browser.

2. Replace the deleted code with code that prints to the browser the following text "Thank you for submitting the poll".

3. In the **HomeController** class, Add **using** statements for the following namespaces:
     - **PollBall.Services;**
     - **System.Text;**

4. In the **HomeController** class, define a new class member using the following information:
      - Type: **IPollResultsService**
      - Name: **_pollResults**
      - Scope: **private**

5. Inject the **IPollResultsService** into the **HomeController's** class constructor, and save it to the **_pollResults** variable.

6. Delete the content of the **index** action of the **HomeController** class.

7. In the **index** action, define and initiate a new variable using the following information:
      - Type: **StringBuilder**
      - Name: **results**

8. In the **index** action, define a new variable using the following information:
      - Type: **SortedDictionary<SelectedGame, int>**
      - Name: **voteList**

9. Below the **gameVotes** declaration, call the **GetVoteResult** method of the **_pollResults** class member, and place the result into the **gameVotes** variable.

10. Below the **GetVoteResult** method call, concatinate each of the game names, and vote counts from the  **voteList** variable, into the **results** variable.

11. In the **index** action, return the **results** variable.

####	Task 5: Run the application.

1. Start the  **PollBall**  project with debugging.

2.  Verify that the **This text was generated by the app.Run middleware. wwwroot folder path:** [local path to your wwwroot folder]** text is displayed in the browser.

3. Access the following relative URL:
     - **/poll-questions.html**

4. Select the **Basketball**  radio button, and click the **Submit Form** button.

5.  Verify that the following text is displayed in the browser:
"Thank you for submitting the poll"

6. Access the following relative URL:
     - **/poll-questions.html**

7. Select the **Football**  radio button, and click the **Submit Form** button.

8.  Verify that the following text is displayed in the browser:
"Thank you for submitting the poll"

9. Access the following relative URL:
     - **/poll-questions.html**

10. Select the **Basketball**  radio button, and click the **Submit Form** button.

11.  Verify that the following text is displayed in the browser:
"Thank you for submitting the poll"

12. Access the following relative URL:
     - **/**

13. Verify that the following text is displayed in the browser:
**Game name: Basketball, Votes: 2** <br> 
**Game name: Football, Votes: 1**

14.  Stop debugging.  

>**Result**: At the end of this exercise, you will be able to create controller, and inject a service into it with **Dependency Injection**. 
