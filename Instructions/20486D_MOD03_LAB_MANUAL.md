# Module 3: Configuring Middleware and Services in ASP.NET Core

# Lab: Configuring Middleware and Services in ASP.NET Core

#### Scenario
The Adventure Works Company wants to develop a website about ball games. For this, the company needs to perform a survey to determine the popularity of different ball games. As their employee, you are required to create a survey site to be used by the company.

#### Objectives

After completing this lab, you will be able to:

-	Use ASP.NET Core static files including HTML, CSS and image files.
-	Create and use a custom middleware and use its context information.
-	Create and use services with ASP.NET Core built-in Dependency Injection.
-	Inject a service to an ASP.NET Core MVC controller.

#### Lab Setup

Estimated Time: **75 minutes**

### Preparation Steps

1.	Ensure that you have cloned the **20486D** directory from GitHub. It contains the code segments for this course's labs and demos. (**https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles**).

### Exercise 1: Working with Static Files

#### Scenario

To create the poll, the application needs a styled HTML page. The HTML page must post the poll results to the server. To transfer the results to the server you will use an HTML form.

The main tasks for this exercise are as follows: 

1.	Create a new project by using the ASP.NET Core Empty project template.

2.	Run the application.

3.	Add an HTML file to the wwwroot folder.

4.	Run the application – content of HTML not displayed.

5.	Enable working with static files.

6.	Run the application – content of HTML is displayed.

7.	Add an HTML file outside of the wwwroot folder.

8.	Run the application – content of HTML outside wwwroot folder not displayed.

####	Task 1: Create a new project using the ASP.NET Core Empty project template

1. Open **Visual Studio 2017** and create a new **ASP.NET Core Web Application** with following information:

    - Name: **PollBall**
    - Location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Create directory for solution: **True**
    - Project template: **Empty**
    - Enable Docker Support: **False**
    - Configure for HTTPS: **False**

2. Delete all the comments in the **Startup** class.

3. Delete the **Configure** method with its content.

4. Add a method with the following information:
    - Scope: **public**
    - Return Type: **void**
    - Name: **Configure**
    - Parameter:
        - Type: **IApplicationBuilder**
        - Name: **app**

5. In the **Configure** method, call the **Run** method of the  **app** parameter. Pass an async **lambda expression** to the **Run** method with the following information:
    - Expression: **async (context) => { }**

6. In the async **lambda expression** code block, call the **context.Response.WriteAsync** method using the **await** operator. Pass **"This text was generated by the app.Run middleware."** as a parameter to the **WriteAsync** method. 

####	Task 2: Run the application

1. Save all the changes.

2. Start the application without debugging.
    > **Note**: The browser displays the following text: "This text was generated by the app.Run middleware."

3. Close **Microsoft Edge**.

####	Task 3: Add an HTML file to the wwwroot folder

1. Create a new folder with the following information:
    - Folder: **css**
    - Parent folder: **wwwroot**

2. Copy the **style.css** file to the **PollBall** project, with the following information:
    - Source location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location:  **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot\css**

3. Copy the **images** folder to the **PollBall** project, with the following information:
    - Source location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location: **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot** 

4. Create a new **HTML Page** with the following information:
    - Folder: **wwwroot**
    - File name: **poll-questions**

5. In the **BODY** element, add a **P** element.

6. In the **P** element, add a **H1** element with the following information: 
    - Content: **Favorite ball game poll**

7. After the **H1** element, add the following content: **Please select your favorite ball game and then press Submit Poll. The poll is anonymous and does not contain names.**

8. After the **P** element, add a **FORM** element with the following information: 
    - Class: **submit-form**

9. In the **FORM** element, add a **DIV** element with the following information: 
    - Class: **main-div**

10. After the **DIV** element, add another **DIV** element with the following information: 
    - Class: **submit-batch**

11. In the **DIV** element with the **submit-batch** class, add an **input** element with the following information: 
    - Type: **submit**
    - Value: **Submit Poll**

12. Copy the content of **html-text.txt** file, with following information:
    - Source location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**

13. In the **poll-questions.html** file, paste the copied content into the **DIV** element with the **main-div** class.

####	Task 4: Run the application – content of HTML not displayed

1. Save all the changes.

2. Start the application without debugging.

3. Access the following relative path:
    - Path: **/poll-questions.html**
    > **Note**: The browser displays the following text:<br>
"This text was generated by the app.Run middleware."

4. Close **Microsoft Edge**.

####	Task 5: Enable working with static files

1. In the **Startup** class, in the **Configure** method code block, call the **UseStaticFiles** method of the **app** parameter.


####	Task 6: Run the application – content of HTML is displayed

1. Save all the changes.

2. Start the application without debugging.

3. Access the following relative path:
    - Path: **/poll-questions.html**
    > **Note**: The browser displays the **poll-questions.html** file content, but the HTML content is not designed by a css file yet.

4. Close **Microsoft Edge**.

5. In the **poll-questions.html** file, in the **HEAD** element, add a **LINK** element with the following information:
    - Type: **text/css**
    - Rel: **stylesheet**
    - Href: **css/style.css**

6. Save all the changes.

7. Start the application without debugging.

8. Access the following relative path: 
    - Path: **/poll-questions.html**
    > **Note**: The browser displays the **poll-questions.html** file content that is designed by the **style.css**.

9. Close **Microsoft Edge**.


####	Task 7: Add an HTML file outside of the wwwroot folder

1.  Copy the **test.html** file to the **PollBall** project, with the following information:
    - Source location: **Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location:  **Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall**

####	Task 8: Run the application – content of HTML outside wwwroot folder not displayed

1. Start the application without debugging.

2. Access the following relative path:
    - Path: **/test.html**
    > **Note**: The browser displays the following text:<br>
"This text was generated by the app.Run middleware."

3. Close **Microsoft Edge**.


>**Result**: At the end of this exercise, you will be able to work with static files inside an ASP.NET Core project.

### Exercise 2: Creating Custom Middleware

#### Scenario

The server must receive the client’s request and notify the company about the poll submission.

The main tasks for this exercise are as follows: 

1. Create a middleware.

2. Run the application.

3. Change the order of middleware.

####	Task 1: Create a middleware

1. In the **Startup** class, in the beginnig of the **Configure** method, call the **Use** method of the  **app** parameter. Pass an async **lambda expression** as a parameter with the following information:

    - Expression: **async (context, next) => { }**

2. In the async **lambda expression** of the **Use** method, add an **IF** statemet that checks if the  **context.Request.Query.ContainsKey** method returns **TRUE**. Pass **"favorite"** as a parameter to the **ContainsKey** method. 

3. Inside the **IF** statment,  add a variable named **selectedValue** of type **string** with the value of **context.Request.Query["favorite"]**.

4. Call the **context.Response.WriteAsync** method using the **await** operator. Pass **"Selected value is: " + selectedValue** as a parameter to the **WriteAsync** method.

5. After the **IF** statment, add an **ELSE** statement.

6. Inside the **ELSE** statment, call the **Invoke** method of the **next** parameter using the **await** operator.

####	Task 2: Run the application

1. Save all the changes.

2. Start the application without debugging.

3. Access the following relative path:
    - Path: **/poll-questions.html**

4. Select **Basketball**, and then click **Submit Poll**.
    > **Note**: The browser displays the following text:<br>
"Selected value is: Basketball"

5. Close **Microsoft Edge**.

####	Task 3: Change the order of middleware

1. In the **Startup** class, in the **Configure** method, move the **app.UseStaticFiles** method call to the beginnig of the middleware pipline.

2. Save all the changes.

3. Start the application without debugging.

4. Access the following relative path:
    - Path: **/poll-questions.html**

5. Select **Basketball**, and then click **Submit Poll**.
    > **Note**: The browser displays the **poll-questions.html** file content located under **wwwroot** folder, since the request was captured by the **UseStaticFiles** middleware without executing the **app.Use** middleware.

6. Close **Microsoft Edge**.

7. Move the **app.UseStaticFiles** method call to be between the **app.Use** middleware and the **app.Run** middleware.

8. In the **app.Use** middleware call, comment out the **ELSE** statement that would run in case the "favorite" query string parameter does not exist.

9. Save all the changes.

10. Start the application without debugging.

11. Access the following relative path:
    - Path: **/poll-questions.html**
    > **Note**: The browser displays a blank page.

12. Close **Microsoft Edge**.

13. Uncomment the **ELSE** statement that would run in case the "favorite" query string parameter does not exist.

>**Result**: At the end of this exercise, you will be able to create a custom middleware and receive HTML form calls to it.

### Exercise 3: Using Dependency Injection

#### Scenario

You will need to aggregate the votes and store them for future use. You will use services to manage and preserve the data.

The main tasks for this exercise are as follows: 

1. Define an interface for a service.

2.	Define an implementation for the service.

3.	Use Dependency Injection.

4.	Run the application.

####	Task 1: Define an interface for a service

1. Create a new top-level folder with the following information:
    - Folder: **Services**

2. Create a new **enum** with the following information:
    - Folder: **Services**
    - Name: **SelectedGame**
    - Values:
        - Basketball
        - Football
        - Soccer
        - Vollyball
        - Billiard
        - Hockey
        - Golf
        - Tennis

3. Create a new **interface** with the following information:
    - Folder: **Services**
    - Name: **IPollResultsService**
    - Scope: **public**

4. In **IPollResultsService** interface, declare a method with following information:
    - Return type: **void**
    - Name: **AddVote**
    - Parameter:
        - Name: **game**
        - Type: **SelectedGame**

5. Declare a method with following information:
    - Name: **GetVoteResult**
    - Return type: **SortedDictionary**&lt;**SelectedGame**, **int**&gt;

####	Task 2: Define an implementation for the service

1. Create a new class with following information:
    - Scope: **Public**
    - Folder: **Services**
    - Name: **PollResultsService**

2. Modify the **PollResultsService** class to implement the **IPollResultsService** interface.

3. Add a new field with the following information:
    - Scope: **private**
    - Type: **Dictionary**&lt;**SelectedGame**, **int**&gt;
    - Name: **_selectionVotes**

4. Add a parameterless constructor with the following information:
    - Scope: **public**

5. In the constructor, initialize the **_selectionVotes** field using the **SortedDictionary&lt;SelectedGame, int&gt;** constructor.

6. Add a method with the following information:
    - Scope: **public**
    - Return Type: **void**
    - Name: **AddVote**
    - Parameter:
        - Type: **SelectedGame**
        - Name: **game**

7. In the **AddVote** method code block, add a **IF** statement that checks that **_selectionVotes.ContainsKey** method returns **TRUE**. Pass **game** as a parameter to the **ContainsKey** method. 

8. In the **IF** statement code block, increment the **_selectionVotes[game]** value by **1**.

9. After the **IF** statement, add an **ELSE** statement.

10.  In the **ELSE** statement code block, call the **Add** method of the **_selectionVotes** field. Pass **game** and **1** as parameters to the **Add** method.

11. Add a method with the following information:
    - Scope: **public**
    - Return Type: **SortedDictionary&lt;SelectedGame, int&gt;**
    - Name: **GetVoteResult**

12. In the **GetVoteResult** method code block, return a new **SortedDictionary&lt;SelectedGame, int&gt;** object using the **SortedDictionary&lt;SelectedGame, int&gt;** constructor. 

13. Pass **_selectionVotes** field as a parameter to the **SortedDictionary&lt;SelectedGame, int&gt;** constructor.


####	Task 3: Use dependency injection

1. In **Startup** class, add **USING** statements for the following namespace:
    - **PollBall.Services**

2. In the **ConfigureServices** method, call the **AddSingleton** method of **services** parameters with the following information: 
    - Interface: **IPollResultsService**
    - Implementation: **PollResultsService**

3. Change  the **Configure** method signature to accept the following parameters:
    - Parameter:
        - Type: **IApplicationBuilder**
        - Name: **app**
    - Parameter:
        - Type: **IHostingEnvironment**
        - Name: **env**
    - Parameter:
        - Type: **IPollResultsService**
        - Name: **pollResults**

4. In the **Configure** method, in the **app.Run** lambda expression code block, replace the string parameter passed to the **WriteAsync** method with the following information:

    - Parameter: **"This text was generated by the app.Run middleware. wwwroot folder path: " + env.WebRootPath**.

5. In the **app.Use** lambda expression code block, delete the call to the **context.Response.WriteAsync**.

6. Inside the **IF** statment,  add a variable named **selectedGame** of type **SelectedGame** with the value of **(SelectedGame)Enum.Parse(typeof(SelectedGame), selectedValue, true)**.

7. Call the **AddVote** method of the **pollResults** parameter. Pass **selectedGame** variable as a parameter to the **AddVote** method.

8. Add a variable named **gameVotes** of type **SortedDictionary&lt;SelectedGame, int&gt;**.  Initialize the **gameVotes** variable with the result of **pollResults.GetVoteResult** method call.

9. Create a **FOREACH** statement block, with the following information:

    - Variable Type: **KeyValuePair&lt;SelectedGame, int&gt;**
    - Variable Name: **currentVote**
    - Collection: **gameVotes**

10.  In the **FOREACH** statement block, call the **context.Response.WriteAsync** method using the **await** operator. Pass **"&lt;div&gt; Game name: {currentVote.Key}, Votes: {currentVote.Value} 	&lt;/div&gt;"** as a parameter to the **WriteAsync** method. 


####	Task 4: Run the application

1. Save all the changes.

2. Start the application without debugging.
    > **Note**: The browser displays the following text:<br>
"This text was generated by the app.Run middleware. wwwroot folder path: [local path to your wwwroot folder]".

3. Access the following relative path:
    - Path: **/poll-questions.html**

4. Select **Basketball**, and then click **Submit Poll**.
    > **Note**: The browser displays the following text:<br>
"Game name: Basketball, Votes: 1"

5. Access the following relative path:
    - Path: **/poll-questions.html**

6. Select **Football**, and then click **Submit Poll**.
    > **Note**: The browser displays the following text:<br>
"Game name: Basketball, Votes: 1<br>
Game name: Football, Votes: 1"

7. Access the following relative path:
    - Path: **/poll-questions.html**

8. Select **Basketball**, and then click **Submit Poll**.
    > **Note**: The browser displays the following text:<br>
"Game name: Basketball, Votes: 2<br>
Game name: Football, Votes: 1"

9. Close **Microsoft Edge**.

 >**Result**:  At the end of this exercise, you will be able to register a service in the **ConfigureServices** method and use the service in the **Configure** method using **Dependency Injection**.

### Exercise 4: Injecting a Service to a Controller

#### Scenario

In this exercise, you will create an ASP.NET Core MVC controller to display the poll results. 

The main tasks for this exercise are as follows: 

1.	Enable working with MVC.

2.	Add a controller.

3.	Run the application.

4.	Use Dependency Injection in a controller.

5.	Run the application.


####	Task 1: Enable working with MVC

1. In the **ConfigureServices** method, call the **AddMVC** method of the **services** parameter.

2. In **Startup** class, in the **Configure** method, between the **app.UseStaticFiles** and the **app.Run** middleware, call the **UseMvcWithDefaultRoute** method of the **app** parameter.

####	Task 2: Add a controller

1. In the **PollBall** project, create a new top-level folder and name it **Controllers**.

2. Create a new controller with the following information:
    - Controller name: **HomeController**
    - Template: **MVC Controller - Empty**
    - Folder: **Controllers**

3. In the **Index** action, return the **ContentResult** result using the **Content** method. Pass **"Hello from controller."** as a parameter to the **Content** method.


####	Task 3: Run the application

1. Save all the changes.

2. Start the application without debugging.
    > **Note**: The browser displays the following text: "Hello from controller."

3. Close **Microsoft Edge**.

4. In **Startup** class, move the **app.UseStaticFiles** to be first middleware in the pipeline.

5. Save all the changes.

6. Start the application without debugging.
    > **Note**: The browser displays: "This text was generated by the app.Run middleware. wwwroot folder path:" [local path to your wwwroot folder]."<br />

7. Close **Microsoft Edge**.

8. Move the **app.Run**  to be the last middleware in the pipeline.

####	Task 4: Use Dependency Injection in a controller

1. In **Startup** class, in the **Configure** method, remove the **gameVotes** variable, the **FOREACH** statement and its content.

2. Call the **context.Response.WriteAsync** method using the **await** operator. Pass **"Thank you for submitting the poll. You may look at the Poll Results &lt;a href='/?submitted=true'&gt;Here&lt;/a&gt;."** as a parameter to the **WriteAsync** method.

3. In **HomeController** class, add **USING** statements for the following namespaces:
    - **PollBall.Services**
    - **System.Text**

4. Add a new field with the following information:
    - Type: **IPollResultsService**
    - Name: **_pollResults**
    - Scope: **private**

5. Add a constructor with the following parameter:
    - Type: **IPollResultsService**
    - Name: **pollResults**

6. In the constructor, initialize the **_pollResults** field with the value of the **pollResults** parameter.

7. Remove the content of the **Index** action.


8. In the **Index** action, add an **IF** statemet that checks if the  **Request.Query.ContainsKey** method returns **TRUE**. Pass **"submitted"** as a parameter to the **ContainsKey** method. 

9. Inside the **IF** statment, add a variable named **results** of type **StringBuilder**.

10. Initialize the **results** varaible using the **StringBuilder** constructor.

11. Add a variable named **voteList** of type **&lt;SortedDictionary&lt;SelectedGame, int&gt;&gt;**.

12. Initialize the **voteList** variable with the result of **_pollResults.GetVoteResult** method call.

13. Create a **FOREACH** statement block, with the following information:

    - Variable Type: **var**
    - Variable Name: **gameVotes**
    - Collection: **voteList**

14. In the **FOREACH** statement block, call the **Append** method of the **results** variable. Pass **$"Game name: {gameVotes.Key}, Votes: {gameVotes.Value}{Environment.NewLine}"** as a parameter to the **Append** method. 

15. After the **FOREACH** statement block, return the **ContentResult** result using the **Content** method. Pass **results.ToString()** string as a parameter to the **Content** method.

16. After the **IF** statment, add  an **ELSE** statemet.

17. Inside the **ELSE** statment, return the **RedirectResult** result using the **Redirect** method. Pass **"poll-questions.html"** as a parameter to the **Redirect** method.

####	Task 5: Run the application

1. Save all the changes.

2. Start the application without debugging.
    >**Note**: The browser displays: **http://localhost:[port]/poll-questions.html** page.

3. Select **Basketball**, and then click **Submit Poll**.
    > **Note**: The browser displays: "Thank you for submitting the poll. You may look at the Poll Results **Here**."

4. click **Here**.
    > **Note**: The browser displays the following text:<br>
"Game name: Basketball, Votes: 1

5. Open a new **Microsoft Edge** window.

6. Access the following relative path:
    - Path: **/poll-questions.html**

7. Select **Football**, and then click **Submit Poll**.
    > **Note**: The browser displays the following text:<br>
"Thank you for submitting the poll. You may look at the Poll Results **Here**."

8. click **Here**.
    > **Note**: The browser displays the following text:<br>
"Game name: Basketball, Votes: 1 <br> 
Game name: Football, Votes: 1"

9. Close all the **Microsoft Edge** windows.

10. Close **Microsoft Visual Studio**.

>**Result**: At the end of this exercise, you will be able to create controller, and inject a service into it with **Dependency Injection**. 

©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the  [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are  **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided &quot;as-is.&quot; Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.